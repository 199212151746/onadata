{% extends 'base.html' %}
{% load i18n %}

{% block additional-headers %}
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />

<link rel="stylesheet" href="/static/css/leaflet.css?v=0.6.2" />
<link rel="stylesheet" href="/static/css/leaflet.draw.css?v=0.2.0-dev" />
<link rel="stylesheet" href="/static/css/map.css" />
<!--[if lte IE 8]>
    <link rel="stylesheet" href="/static/css/leaflet.ie.css?v=0.6.2" />
    <link rel="stylesheet" href="/static/css/leaflet.draw.ie.css?v=0.2.0-dev" />
<![endif]-->
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js"></script>
<script type="text/javascript" src="/static/js/json2.js"></script>
<script type="text/javascript" src="/static/js/dv.js"></script>
<script src="/static/js/d3.js" type="text/javascript"></script>
<script src="/static/js/hex.js" type="text/javascript"></script>
<script src="/static/js/d3.hexbin.js" type="text/javascript"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.6.4/leaflet.js"></script>
<script type="text/javascript" src="/static/js/leaflet.draw.js?v=0.2.0-dev"></script>
<script type="text/javascript" src="/static/js/mapbox.standalone.js?v=1.1.0"></script>
<script type="text/javascript" src="/static/js/custom-button-leaflet.js"></script>
<script src="https://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>
<script type="text/javascript" src="/static/js/Google.js"></script>
<script type="text/javascript" src="/static/js/wax.leaf.min.js?v=6.4.0"></script>
<script type="text/javascript" src="/static/js/TileLayer.Bing.js"></script>
{% endblock %}

{% block body %}
<body>
  {% include "topbar.html" %}

  {% if mapbox_layer %}
  <script type="text/javascript">
    var customMapBoxTileLayer = {label: '{{mapbox_layer.map_name}}', url: '{{mapbox_layer.link}}'};
  </script>
  {% endif %}
  <div id="progress-modal" class="modal hide fade" data-backdrop="static">
      <div class="progress progress-info progress-striped">
          <div class="bar" style="width: 1%"></div>
      </div>
  </div>
  <div id="map_canvas"></div>
  <div id="enketo-modal" class="modal hide enketo-modal"></div>
	<div id="delete-modal" class="modal hide fade">
	    <div class="modal-header">
	      <a data-dismiss="modal" class="close">&times;</a>
	      <h3>{% trans "Delete Confirmation" %}</h3>
	    </div>
	    <div class="modal-body">
	      <p>{% trans "Are you sure you want to delete this record. If you are unsure about deleting this record press 'Cancel'." %}</p>
	    </div>
	    <div class="modal-footer">
	      <a href="#" onclick="deleteData();" class="btn btn-primary">{% trans "Delete" %}</a>
	      <a href="#" onclick="$('#delete-modal').modal('hide');" class="btn secondary">{% trans "Cancel" %}</a>
	    </div>
	</div>
<script src="/static/js/map.js?ts=201310221330" type="text/javascript"></script>
{% if mapbox_layer %}
<script type="text/javascript">
	var customMapBoxTileLayer = {label: '{{mapbox_layer.map_name}}', url: '{{mapbox_layer.link}}'};
</script>
{% endif %}
<script type="text/javascript">
	var center = {{ center|safe }};
    var default_zoom = 13;
	var formJSONUrl = "{{ jsonform_url }}";
	var enketoAddUrl = "{{ enketo_add_url }}";
	var enketoEditUrl = "{{ enketo_edit_url }}";
	enketoEditUrl = enketoEditUrl.slice(0, enketoEditUrl.length - 1);
	var mongoAPIUrl = "{{ mongo_api_url }}";
	var deleteAPIUrl = "{{ delete_data_url }}";
    var language_code = "{{LANGUAGE_CODE}}";
	var attachmentsBaseUrl = "{% url "odk_viewer.views.attachment_url" %}";

	function setMapHeight(){
        var newHeight = $(window).height() - $('.navbar-inner').height();
        $('#map_canvas').height(newHeight);
	}

    $(document).ready(setMapHeight);
	$(window).resize(setMapHeight);

    (function(){
        FHMap.init('map_canvas', {
            zoom: default_zoom,
            center: [center.lat, center.lng]
        });

        var mapbox_layer_configs = [
            {label: gettext('Mapbox Streets'), user: 'modilabs', map: 'map-iuetkf9u'},
            {label: gettext('MapBox Streets Light'), user: 'modilabs', map: 'map-p543gvbh'},
            {label: gettext('MapBox Streets Zenburn'), user: 'modilabs', map: 'map-bjhr55gf'},
            {label: gettext('Cloudless Earth'), user: 'modilabs', map: 'map-aef58tqo'},
            {label: gettext("Mapbox Streets (Français)"), user: 'modilabs', map: 'map-vdpjhtgz', lang: 'fr'},
            {label: gettext("Mapbox Streets (Español)"), user: 'modilabs', map: 'map-5gjzjlah', lang: 'es'}
        ];
        var base_layers = [];

        mapbox_layer_configs.forEach(function(layer_config){
            var layer = new L.TileLayer.MapBox({user: layer_config.user, map: layer_config.map});
            base_layers.push({
                title: layer_config.label,
                layer: layer,
                lang: layer_config.lang,
                is_custom: false
            });
        });

        // check for a user defined map
        if (typeof customMapBoxTileLayer !== "undefined" && customMapBoxTileLayer) {
            base_layers.push({
                title: customMapBoxTileLayer.label,
                layer: L.tileLayer(customMapBoxTileLayer.url, {attribution: customMapBoxTileLayer.attribution}),
                lang: customMapBoxTileLayer.lang,
                is_custom: true
            });
        }

        // add google sat layer
        base_layers.push({
            title: gettext("Google Satellite Map"),
            layer: new L.Google('HYBRID'),
            is_custom: false
        });

        // set default layer
        FHMap.determineDefaultLayer(base_layers, language_code);

        // add base layers
        base_layers.forEach(function(base_layer){
           FHMap.addBaseLayer(base_layer.layer, base_layer.title, base_layer.is_default);
        });
    })();
</script>
</body>
{% endblock %}
