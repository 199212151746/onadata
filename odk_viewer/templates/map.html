{% extends 'base.html' %}

{% block additional-headers %}
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />

<link rel="stylesheet" href="/static/css/leaflet.css?v=0.5.1" />
<link rel="stylesheet" href="/static/css/map.css" />
<!--[if lte IE 8]>
    <link rel="stylesheet" href="/static/css/leaflet.ie.css?v=0.5.1" />
<![endif]-->
<script type="text/javascript" src="/static/js/json2.js"></script>
<script type="text/javascript" src="/static/js/leaflet.js?v=0.5.1"></script>
<script type="text/javascript" src="/static/js/custom-button-leaflet.js"></script>
<script src="https://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>
<script type="text/javascript" src="/static/js/Google.js"></script>
<script type="text/javascript" src="/static/js/wax.leaf.min.js"></script>
<script type="text/javascript" src="/static/js/TileLayer.Bing.js"></script>
<script type="text/javascript" src="/static/js/formManagers.js?ts=201303251542"></script>
<script type="text/javascript" src="/static/js/jquery.ba-bbq.min.js"></script>
<script type="text/javascript">
	var center = {{ center|safe }};
	var formJSONUrl = "{{ jsonform_url }}";
	var enketoAddUrl = "{{ enketo_add_url }}";
	var enketoEditUrl = "{{ enketo_edit_url }}";
	enketoEditUrl = enketoEditUrl.slice(0, enketoEditUrl.length -1);
	var mongoAPIUrl = "{{ mongo_api_url }}";
  var language_code = "{{LANGUAGE_CODE}}";
	var attachmentsBaseUrl = "{% url odk_viewer.views.attachment_url %}";
	$('#selectLanguage').live('change', function() {
	    $('.language').hide();
	    $('.' + $(this).val()).show();
	});
	function setMapHeight(){
	  var newHeight = $(window).height()-
	      $('.navbar-inner').height()
	  $('#map_canvas').height(newHeight);
	}

	function exitModal(modalElem) {
		$(modalElem).empty();
		$(modalElem).modal('hide');
	}

	function displayEnketoModal(url) {
		console.log("displayEnketoModal with: " + url);
    	var modalVisible = null;
    	$("#enketo-modal").empty();

    	var closeButton = $("<button class='btn' style='position: absolute; top: 0;right: 0;'>Close</button>");
    	closeButton.click(function () {
    		var modalElem = $(this).parent();
    		exitModal(modalElem);
    	});

    	var aFrame = $('<iframe src="' + url + '" style="width:100%; min-height:300px;overflow-x: hidden; overflow-y: scroll" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" vspace="0" hspace="0"></iframe>');
    	// event fired when src attr changes
    	aFrame.load(function(){
    		// first time is the real load.
			if (modalVisible === null) {
				modalVisible = true;
				return;
			}
			// second time is the redirect. close the modal
			if (modalVisible === true) {
				modalVisible = false;
				exitModal($("#enketo-modal"));
				return;
			}
		});
		$("#enketo-modal").append(closeButton);
    	$("#enketo-modal").append(aFrame);
		$("#enketo-modal").modal();
	}

	$(document).ready(function() {
	    setMapHeight();
	    $('#progress-modal').modal({
	        keyboard: false
	    });

	    // add a submission button
	    $('.add-submission').click(function () {
	    	var url = enketoAddUrl;
			displayEnketoModal(url);
    	});
	});

	$(window).resize(setMapHeight);
</script>
<script src="/static/js/mapview.js?ts=201305301330" type="text/javascript"></script>
<script src="/static/js/underscore-min.js" type="text/javascript"></script>
<script src="/static/js/d3.js" type="text/javascript"></script>
<script src="/static/js/dv.js" type="text/javascript"></script>
<script src="/static/js/hex.js" type="text/javascript"></script>
<script src="/static/js/d3.hexbin.js" type="text/javascript"></script>
{% endblock %}

{% block body %}
<body onload="initialize()">
  {% include "topbar.html" %}

  {% if mapbox_layer %}
  <script type="text/javascript">
    var customMapBoxTileLayer = {label: '{{mapbox_layer.map_name}}', url: '{{mapbox_layer.link}}'};
  </script>
  {% endif %}
  <div id="progress-modal" class="modal hide fade" data-backdrop="static">
      <div class="progress progress-info progress-striped">
          <div class="bar" style="width: 1%"></div>
      </div>
  </div>
  <div id="map_canvas"></div>
  <div id="enketo-modal" class="modal hide fade">
  </div>
</body>
{% endblock %}
