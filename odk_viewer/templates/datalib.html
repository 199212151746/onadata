{% extends 'base.html' %}
{% load i18n %}

{% block additional-headers %}
    <link rel="stylesheet" href="/static/css/leaflet.css" />
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="/static/css/leaflet.ie.css" />
    <![endif]-->
    <script type="text/javascript" src="/static/js/json2.js"></script>
    <script type="text/javascript" src="/static/js/leaflet.js"></script>
    <script src="https://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>
    <script type="text/javascript" src="/static/js/Google.js"></script>
    <script type="text/javascript" src="/static/js/wax.leaf.min.js"></script>
    <script src="/static/js/underscore-min.js" type="text/javascript"></script>
    <script src="/static/js/dv.js" type="text/javascript"></script>

    <!-- recline -->
    <script type="text/javascript" charset="utf-8" src="/static/js/recline/vendor/backbone/0.9.2/backbone.js"></script>
    <script type="text/javascript" charset="utf-8" src="/static/js/recline/vendor/mustache/0.5.0-dev/mustache.js"></script>
    <script type="text/javascript" charset="utf-8" src="/static/js/recline/recline.js"></script>

    <!-- formhub -->
    <script type="text/javascript" charset="utf-8" src="/static/js/fh.dataset.js"></script>
    <script type="text/javascript" charset="utf-8" src="/static/js/fh.template.js"></script>
    <script type="text/javascript" charset="utf-8" src="/static/js/fh.dataview.js"></script>
    <script type="text/javascript" charset="utf-8" src="/static/js/backend.formhub.js"></script>

    <style type="text/css">
    .fh-map-container > .map, .my-map > .map {
        height: 500px; /* temporary */
    }
    </style>
{% endblock %}

{% block content %}
<script type="text/javascript">
    var mapCentre = {"lat": "34.571258", "lng": "-2.481061"};
    var defaultZoom = 8;
    var formJSONUrl = "{% url odk_logger.views.download_jsonform username id_string %}";
    var mongoAPIUrl = "{% url main.views.api username id_string %}";
    var csvUrl = "{% url odk_viewer.views.csv_export username id_string %}";
    var mapBoxAdditAttribution = gettext("Map data (c) OpenStreetMap contributors, CC-BY-SA");
    var mapboxMaps = [
        {'label': gettext('Mapbox Streets'), 'url': 'http://a.tiles.mapbox.com/v3/modilabs.map-iuetkf9u.jsonp', default: true},
        {'label': gettext('MapBox Streets Light'), 'url': 'http://a.tiles.mapbox.com/v3/modilabs.map-p543gvbh.jsonp', default: false},
        {'label': gettext('MapBox Streets Zenburn'), 'url': 'http://a.tiles.mapbox.com/v3/modilabs.map-bjhr55gf.jsonp', default: false},
        {'label': gettext('Natural Earth II'), 'url': 'http://a.tiles.mapbox.com/v3/modilabs.map-1c1r9n5g.jsonp', default: false}
    ];

    var dataset = new fh.Dataset({
        backend: "formhub",
        formurl: formJSONUrl,
        dataurl: mongoAPIUrl,
        limit: 500
    });

    var views = [
        {
            id: 'map',
            label: 'Map',
            view: new fh.Map({
                className: 'my-map',
                center: mapCentre,
                baseLayers: [
                    {
                        label: 'Google Satellite',
                        layer: new L.Google()
                    }
                ],
                mapboxLayers: mapboxMaps,
                featureLayers: [
                    new fh.MarkerLayer({
                        label: "Markers",
                        model: dataset,
                        idField: fh.constants._ID
                    })
                ]
            })
        },
        {
            id: 'grid',
            label: 'Grid',
            view: new recline.View.Grid({
                model: dataset
            })
        }
    ];

    var dataview;

    $(document).ready(function() {
        // do this here where the DOM is ready
        dataview = new fh.DataView({
            views: views,
            el: $('#data-container'),
            template: fh.template.dataview
        });
        // populate the dataset
        dataset.fetch();
    });
</script>
<div id="data-container"></div>
{% endblock %}