{% extends 'base.html' %}

{% block content %}
<span id="pivot-detail"></span>
<hr/>
<div id="results"></div>
<script type="text/javascript" src="/static/js/formManagers.js"></script>
<script type="text/javascript" src="/static/js/jquery.dataTables.js"></script>
<script type="text/javascript" src="/static/js/pivot.js"></script>
<script type="text/javascript" src="/static/js/jquery_pivot.js"></script>
<script type="text/javascript" src="/static/js/dataTables.bootstrap.js"></script>
<script type="text/javascript">

var formJSONUrl = "{{ jsonform_url }}";
var mongoAPIUrl = "{{ mongo_api_url }}";
var formResponseMngr = new FormResponseManager(mongoAPIUrl, loadResponseDataCallback);
var formJSONMngr = new FormJSONManager(formJSONUrl, loadFormJSONCallback);

$(document).ready(function(){
    // load form
    formJSONMngr.loadFormJSON();
});

function loadFormJSONCallback()
{
    /// we have loaded the form, now load the data
    formResponseMngr.loadResponseData({});
}

function loadResponseDataCallback()
{
    var fields = formJSONMngr.getPivotJsFields();
    var rowLabels = formJSONMngr.getRowLabels();
    var data = formResponseMngr.getAsPivotJs(rowLabels);

    // format the data into pivots array array format
    $('#pivot-container').pivot_display('setup', {json: data, fields: fields, rowLabels: rowLabels, 'callbacks':{
        afterUpdateResults: function(){
            $('#results > table').dataTable({
                "sDom": "<'row'<'span6'l><'span6'f>>t<'row'<'span6'i><'span6'p>>",
                "iDisplayLength": 50,
                "aLengthMenu": [[25, 50, 100, -1], [25, 50, 100, "All"]],
                "sPaginationType": "bootstrap",
                "oLanguage": {
                    "sLengthMenu": "_MENU_ records per page"
                }
            });
        }
    }})
}
</script>
{% endblock %}
