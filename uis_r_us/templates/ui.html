{% extends "ui_base.html" %}
{% block head %}
<style type="text/css" media="screen">
</style>
<link rel="stylesheet" href="/static/openlayers/default/style.css" type="text/css" media="all" charset="utf-8">
{% endblock %}
{% block content %}
<!--
<table><tbody><tr><td><a href="#/submission-counts" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button"><span class="ui-button-text" style="padding-top: 1px; padding-right: 5px; padding-bottom: 1px; padding-left: 5px; ">Â« Back to the List of LGAs</span></a></td><td id="map-type-choices"><div style="float: right; "><a href="#" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button"><span class="ui-button-text" style="padding-top: 1px; padding-right: 5px; padding-bottom: 1px; padding-left: 5px; ">Terrain</span></a><a href="#" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button"><span class="ui-button-text" style="padding-top: 1px; padding-right: 5px; padding-bottom: 1px; padding-left: 5px; ">Satellite</span></a><a href="#" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button"><span class="ui-button-text" style="padding-top: 1px; padding-right: 5px; padding-bottom: 1px; padding-left: 5px; ">Map</span></a></div></td></tr>
</tbody></table>

-->
<script type="text/html" id="map-bar-template">
	<div class="map-key-ww">
		<div class="map-key-w">
			<div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix" id="m-key">
				<table>
					<tbody>
						<tr></tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>
</script>
<div class='content-inner-wrap'>
	<div class="widget-outer-wrap" style="bottom:0">
		<div class="fullw-widget">
			<div id="lga-facilities-table"></div>
		</div>
	</div>
	<div id="map" class="resizing-map"></div>
	<div id="zone-navigation">
		{% for zone in nav_zones %}
		<div class="zl-wrap">
			<div class="zone-list">
				<h2 class="zone-title">
					{{zone.name}}
				</h2>
				<ul>
					{% for state in zone.states %}
					<li>
						<a href="#" class="state-link" data-lga-count="{{state.lga_count}}">
							{{state.name}}
						</a>
						<ul class="lga-list">
							{% for lga in state.lgas %}
							<li>
								<a href="/~{{lga.unique_slug}}">
									{{lga.name}}
								</a>
							</li>
							{% endfor %}
						</ul>
					</li>
					{% endfor %}
				</ul>
			</div>
		</div>
		{% endfor %}
		<div class="clearfix">
		</div>
	</div>
</div>
<div id="gap-analysis-table-template" style="display:none">
	<div>
	<h2>Health</h2>
	<table class="gap-analysis">
		<tbody>
			<tr>
				<td colspan="2" class="blank"></td>
				<td>Current</td>
				<td>Target</td>
				<td>Gap</td>
			</tr>
			<tr>
				<td rowspan="3">
					Facilities Per Population
				</td>
				<td>
					Insitutional Delivery
				</td>
				<td class="fill-me centered" data-variable-slug="num_health_facilities_institutional_delivery_only"></td>
				<td class="fill-me centered" data-variable-slug="target_health_facilities_institutional_delivery_only"></td>
				<td class="fill-me centered" data-variable-slug="gap_health_facilities_institutional_delivery_only"></td>
			</tr>
			<tr>
				<td>
					Basic EmOC
				</td>
				<td class="fill-me centered" data-variable-slug="num_health_facilities_basic_emoc_fully_functional"></td>
				<td class="fill-me centered" data-variable-slug="target_health_facilities_basic_emoc"></td>
				<td class="fill-me centered" data-variable-slug="gap_health_facilities_basic_emoc"></td>
			</tr>
			<tr>
				<td>
					Comprehensive EmOC
				</td>
				<td class="fill-me centered" data-variable-slug="num_health_facilities_comprehensive_emoc_fully_functional"></td>
				<td class="fill-me centered" data-variable-slug="target_health_facilities_comprehensive_emoc"></td>
				<td class="fill-me centered" data-variable-slug="gap_health_facilities_comprehensive_emoc"></td>
			</tr>
		</tbody>
		<tbody>
			<tr>
				<td colspan="2" class="blank"></td>
				<td>Current</td>
				<td>Target</td>
				<td>Gap</td>
			</tr>
			<tr>
				<td rowspan="5">
					Infrastructure
				</td>
				<td>
					Emergency Transport
				</td>
				<td class="fill-me centered" data-variable-slug="num_health_facilities_with_functioning_emergency_transport"></td>
				<td class="fill-me centered" data-variable-slug="num_primary_health_facilities"></td>
				<td class="fill-me centered" data-variable-slug="gap_health_facilities_emergency_transport"></td>
			</tr>	
			<tr>
				<td>
					Mobile Communications
				</td>
				<td class="fill-me centered" data-variable-slug="num_health_facilities_functioning_mobile_and_coverage"></td>
				<td class="fill-me centered" data-variable-slug="num_primary_health_facilities"></td>
				<td class="fill-me centered" data-variable-slug="gap_health_facilities_functioning_mobile_communications"></td>
			</tr>
			<tr>
				<td>
					Improved Water
				</td>
				<td class="fill-me centered" data-variable-slug="num_health_facilities_potable_water_past_mth"></td>
				<td class="fill-me centered" data-variable-slug="num_primary_health_facilities"></td>
				<td class="fill-me centered" data-variable-slug="gap_health_facilities_potable_water"></td>
			</tr>
			<tr>
				<td>
					Improved Sanitation
				</td>
				<td class="fill-me centered" data-variable-slug="num_health_facilities_with_functioning_improved_sanitation"></td>
				<td class="fill-me centered" data-variable-slug="num_primary_health_facilities"></td>
				<td class="fill-me centered" data-variable-slug="gap_health_facilities_functioning_improved_sanitation"></td>
			</tr>
			<tr>
				<td>
					Power
				</td>
				<td class="fill-me centered" data-variable-slug="num_health_facilities_power_access_and_functional"></td>
				<td class="fill-me centered" data-variable-slug="num_primary_health_facilities"></td>
				<td class="fill-me centered" data-variable-slug="gap_health_facilities_power_access_and_funtional"></td>
			</tr>
		</tbody>
		<tbody>
			<tr>
				<td colspan="2" class="blank"></td>
				<td>Current</td>
				<td>Target</td>
				<td>Gap</td>
			</tr>
			<tr>
				<td rowspan="3">
					Equipment, Drugs &amp; Diagnostics
				</td>
				<td>
					Minimum Equipment Package
				</td>
				<td class="fill-me centered" data-variable-slug="num_health_facilities_with_min_equipment_package"></td>
				<td class="fill-me centered" data-variable-slug="num_primary_health_facilities"></td>
				<td class="fill-me centered" data-variable-slug="gap_health_facilities_with_min_equip_package"></td>
			</tr>
			<tr>
				<td>
					Minimum Essential Medications
				</td>
				<td class="fill-me centered" data-variable-slug="num_health_facilities_with_min_essential_meds"></td>
				<td class="fill-me centered" data-variable-slug="num_primary_health_facilities"></td>
				<td class="fill-me centered" data-variable-slug="gap_health_facilities_with_min_essential_meds"></td>
			</tr>
			<tr>
				<td>
					Minimum Laboratory Diagnostics
				</td>
				<td class="fill-me centered" data-variable-slug="num_health_facilities_with_min_lab_diagnostics"></td>
				<td class="fill-me centered" data-variable-slug="num_all_primary_health_facilities"></td>
				<td class="fill-me centered" data-variable-slug="gap_health_facilities_minimum_lab_diagnostics"></td>
			</tr>
		</tbody>
		<tbody>
			<tr>
				<td colspan="2" class="blank"></td>
				<td>Current</td>
				<td>Target</td>
				<td>Gap</td>
			</tr>
			<tr>
				<td rowspan="4">
					Malaria
				</td>
				<td>
					Facilities with ITNs
				</td>
				<td class="fill-me centered" data-variable-slug="num_health_facilities_with_itns"></td>
				<td class="fill-me centered" data-variable-slug="num_all_primary_health_facilities"></td>
				<td class="fill-me centered" data-variable-slug="gap_health_facilities_with_itns"></td>
			</tr>
			<tr>
				<td>
					Facilities with RDT
				</td>
				<td class="fill-me centered" data-variable-slug="num_health_facilities_with_malaria_testing"></td>
				<td class="fill-me centered" data-variable-slug="num_all_primary_health_facilities"></td>
				<td class="fill-me centered" data-variable-slug="gap_health_facilities_with_malaria_testing"></td>
			</tr>
			<tr>
				<td>
					Facilities with ACT
				</td>
				<td class="fill-me centered" data-variable-slug="num_health_facilities_with_artemisinin_for_malaria"></td>
				<td class="fill-me centered" data-variable-slug="num_all_primary_health_facilities"></td>
				<td class="fill-me centered" data-variable-slug="gap_health_facilities_with_artemisinin_for_malaria"></td>
			</tr>
			<tr>
				<td>
					Facilities with SP
				</td>
				<td class="fill-me centered" data-variable-slug="num_health_facilities_with_malaria_treatment_sulphadoxine"></td>
				<td class="fill-me centered" data-variable-slug="num_all_primary_health_facilities"></td>
				<td class="fill-me centered" data-variable-slug="gap_health_facilities_with_sulphadoxine_for_malaria"></td>
			</tr>
		</tbody>
		<tbody>
			<tr>
				<td colspan="2" class="blank"></td>
				<td>Current</td>
				<td>Target</td>
				<td>Gap</td>
			</tr>
			<tr>
				<td rowspan="1">
					Vaccination
				</td>
				<td>
					Routine Immunization
				</td>
				<td class="fill-me centered" data-variable-slug="num_health_facilities_routine_immunization"></td>
				<td class="fill-me centered" data-variable-slug="num_all_primary_health_facilities"></td>
				<td class="fill-me centered" data-variable-slug="gap_health_facilities_routine_immunization"></td>
			</tr>
		</tbody>
		<tbody>
			<tr>
				<td colspan="2" class="blank"></td>
				<td>Current</td>
				<td>Target</td>
				<td>Gap</td>
			</tr>
			<tr>
				<td rowspan="5">
					Staffing
				</td>
				<td>
					Physicians
				</td>
				<td class="fill-me centered" data-variable-slug="num_hospitals_with_at_least_one_fulltime_doctor"></td>
				<td class="fill-me centered" data-variable-slug="num_hospitals"></td>
				<td class="fill-me centered" data-variable-slug="gap_hospitals_with_at_least_one_fulltime_doctor"></td>
			</tr>
			<tr>
				<td>
					Midwives and Nurse-midwives
				</td>
				<td class="fill-me centered" data-variable-slug="num_primary_care_with_min_3_midwives_and_nursemidwives"></td>
				<td class="fill-me centered" data-variable-slug="num_primary_health_facilities"></td>
				<td class="fill-me centered" data-variable-slug="gap_primary_care_with_min_3_midwives_and_nursemidwives"></td>
			</tr>
			<tr>
				<td>
					Nurses
				</td>
				<td class="fill-me centered" data-variable-slug="num_primary_care_with_min_2_nurses_fulltime"></td>
				<td class="fill-me centered" data-variable-slug="num_primary_health_facilities"></td>
				<td class="fill-me centered" data-variable-slug="gap_primary_care_with_min_2_nurses"></td>
			</tr>
			<tr>
				<td>
					Senior CHEWs
				</td>
				<td class="fill-me centered" data-variable-slug="num_primary_care_with_min_4_sr_chews"></td>
				<td class="fill-me centered" data-variable-slug="num_primary_health_facilities"></td>
				<td class="fill-me centered" data-variable-slug="gap_primary_health_facility_with_min_4_sr_CHEW"></td>
			</tr>
			<tr>
				<td>
					Junior CHEWs
				</td>
				<td class="fill-me centered" data-variable-slug="num_basic_facilities_with_min_1_jr_chew"></td>
				<td class="fill-me centered" data-variable-slug="num_basic_health_facilities"></td>
				<td class="fill-me centered" data-variable-slug="gap_basic_primary_with_min_1_jr_chew"></td>
			</tr>
		</tbody>
	</table>
	<h2>Education</h2>
	<table class="gap-analysis">
		<tbody>
			<tr>
				<td colspan="2" class="blank"></td>
				<td>Current</td>
				<td>Target</td>
				<td>Gap</td>
			</tr>
			<tr>
				<td rowspan="3">
					Schools &amp; Classrooms
				</td>
				<td>
					Schools
				</td>
				<td class="fill-me centered" data-variable-slug="num_primary_schools"></td>
				<td class="fill-me centered" data-variable-slug="target_num_primary_schools"></td>
				<td class="fill-me centered" data-variable-slug="gap_primary_schools"></td>
			</tr>
			<tr>
				<td>
					Classrooms
				</td>
				<td class="fill-me centered" data-variable-slug="num_primary_classrooms_good_cond"></td>
				<td class="fill-me centered" data-variable-slug="target_num_primary_classrooms"></td>
				<td class="fill-me centered" data-variable-slug="gap_primary_school_classrooms_good_cond"></td>
			</tr>
		</tbody>
		<tbody>
			<tr>
				<td colspan="2" class="blank"></td>
				<td>Current</td>
				<td>Target</td>
				<td>Gap</td>
			</tr>
			<tr>
				<td rowspan="3">
					Infrastructure
				</td>
				<td>
					Water
				</td>
				<td class="fill-me centered" data-variable-slug="num_primary_schools_with_potable_water"></td>
				<td class="fill-me centered" data-variable-slug="num_primary_schools"></td>
				<td class="fill-me centered" data-variable-slug="gap_primary_schools_potable_water"></td>
			</tr>
			<tr>
				<td>
					Sanitation
				</td>
				<td class="fill-me centered" data-variable-slug="num_primary_schools_with_improved_sanitation_functioning"></td>
				<td class="fill-me centered" data-variable-slug="num_primary_schools"></td>
				<td class="fill-me centered" data-variable-slug="gap_primary_schools_improved_sanitation_functioning"></td>
			</tr>
		</tbody>
		<tbody>
			<tr>
				<td colspan="2" class="blank"></td>
				<td>Current</td>
				<td>Target</td>
				<td>Gap</td>
			</tr>
			<tr>
				<td rowspan="3">
					Furniture
				</td>
				<td>
					Chalkboards
				</td>
				<td class="fill-me centered" data-variable-slug="num_primary_schools_with_chalkboards_each_classroom"></td>
				<td class="fill-me centered" data-variable-slug="num_primary_schools"></td>
				<td class="fill-me centered" data-variable-slug="gap_primary_schools_with_chalkboards_each_classroom"></td>
			</tr>
			<tr>
				<td>
				    Benches
				</td>
				<td class="fill-me centered" data-variable-slug="primary_school_benches"></td>
				<td class="fill-me centered" data-variable-slug="sum_target_primary_school_benches"></td>
				<td class="fill-me centered" data-variable-slug="gap_benches_primary_schools"></td>
			</tr>
			<tr>
				<td>
			        Desks
				</td>
				<td class="fill-me centered" data-variable-slug="primary_school_desks"></td>
				<td class="fill-me centered" data-variable-slug="sum_target_primary_school_desks"></td>
				<td class="fill-me centered" data-variable-slug="gap_desks_primary_schools"></td>
			</tr>
		</tbody>
		<tbody>
			<tr>
				<td colspan="2" class="blank"></td>
				<td>Current</td>
				<td>Target</td>
				<td>Gap</td>
			</tr>
			<tr>
				<td rowspan="4">
					Teaching Materials
				</td>
				<td>
					Textbooks
				</td>
				<td class="fill-me centered" data-variable-slug="primary_school_textbooks"></td>
				<td class="fill-me centered" data-variable-slug="sum_target_primary_school_textbooks"></td>
				<td class="fill-me centered" data-variable-slug="gap_textbooks_primary_schools"></td>
			</tr>
			<tr>
				<td>
					Excercise Books
				</td>
				<td class="fill-me centered" data-variable-slug="primary_school_exercise_books"></td>
				<td class="fill-me centered" data-variable-slug="sum_target_primary_school_exercise_books"></td>
				<td class="fill-me centered" data-variable-slug="gap_exercise_books_primary_schools"></td>
			</tr>
			<tr>
				<td>
					Pens/Pencils
				</td>
				<td class="fill-me centered" data-variable-slug="num_primary_schools_with_sufficient_pens"></td>
				<td class="fill-me centered" data-variable-slug="num_primary_schools"></td>
				<td class="fill-me centered" data-variable-slug="gap_primary_schools_with_sufficient_pens"></td>
			</tr>
			<tr>
				<td>
					Teaching Toolkits
				</td>
				<td class="fill-me centered" data-variable-slug="num_primary_schools_natl_curriculum_and_teaching_kit"></td>
				<td class="fill-me centered" data-variable-slug="num_primary_schools"></td>
				<td class="fill-me centered" data-variable-slug="gap_primary_schools_natl_curriculum_and_teaching_kit"></td>
			</tr>
		</tbody>
		<tbody>
			<tr>
				<td colspan="2" class="blank"></td>
				<td>Current</td>
				<td>Target</td>
				<td>Gap</td>
			</tr>
			<tr>
				<td rowspan="1">
					Staff
				</td>
				<td>
					Qualified Teachers
				</td>
				<td class="fill-me centered" data-variable-slug="primary_school_teachers_qualified"></td>
				<td class="fill-me centered" data-variable-slug="num_primary_classrooms_good_cond"></td>
				<td class="fill-me centered" data-variable-slug="gap_qualified_teachers_primary_schools"></td>
			</tr>
		</tbody>
	</table>
	</div>
</div>
{% endblock %}
{% block js %}
<script src="/static/js/application.js" type="text/javascript" charset="utf-8"></script>
<script src="/static/js/launch-open-layers.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" charset="utf-8">
<!--

var debugMode = false;

var pageRootUrl = "/~";

var defaultSectorSlug = 'health';

var loadMap = true;
//var loadMap = $("input#load-map").attr('checked');

-->
</script>
<script src="/static/js/lga-dashboard.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" charset="utf-8">
<!--

//layer data is pulled from the database now.
var layerData = (function(_){return _})({{layer_details|safe}});

$('.content-inner-wrap').css({'padding':0});


var mapBar = (function(){
	var _placed = false;
	var _elem;
	var defaultOpts = {
		'preSectorButtons': [
			['Overview', 'overview']
		],
		'sectorButtons': [
//			['Summary', 'summary'],
			['Health', 'health'],
			['Water', 'water'],
			['Education', 'education']
		],
		'viewLevels': [
			['LGA level', 'lga'],
			['Facility level', 'facility']
		],
		reset: true
	};
	return function getMapBar(_opts){
		var opts = $.extend(defaultOpts, _opts);
		if(!_placed) {
			_elem = $($('#map-bar-template').html());
			$('.content-inner-wrap').prepend(_elem);
			_placed = true;
		}
		var tr = _elem.find('tr');
		opts.reset && tr.empty()
		var sectorTd = $('<td />');
		if(!!opts.preSectorButtons && opts.preSectorButtons.length > 0) {
			$.each(opts.preSectorButtons, function(i, button){
				$('<a />', {'href': '#', 'class': 'preSectorButton'})
						.text(button[0])
						.appendTo(sectorTd)
						.data('sectorSlug', button[1]);
			});
			sectorTd.append($('<span />', {'class':'spacer'}))
		}
		$.each(opts.sectorButtons, function(i, button){
			$('<a />', {'href': '#', 'class': 'sectorButton'})
					.text(button[0])
					.appendTo(sectorTd)
					.data('sectorSlug', button[1]);
		});
		sectorTd.delegate('a', 'click', function(){
			var ss =  $(this).data('sectorSlug');
			var sData = {viewLevel: 'facility'};
			if(!!ss) {
				sData.fullSectorId = ss;
			}
			$('body').trigger('select-sector', sData);
		});

		var viewLevelTd = $('<td />');
		$.each(opts.viewLevels, function(i, button){
			$('<a />', {'href':'#', 'class':'viewLevelButton'})
				.text(button[0])
				.appendTo(viewLevelTd)
				.data('viewLevel', button[1])
				.click(function(){
					$('body').trigger('select-view-level', {
						viewLevel: $(this).data('viewLevel')
					});
				})
		});
		tr
			.append(sectorTd)
			.append(viewLevelTd);
		return {
			elem: _elem
		};
	}
})();

var modes = {
	home: {
		enter: function(){
			$('.widget-outer-wrap').hide()
			$('.fwidth').width(1100)
			var zlHeight = 0;
			$('.content-inner-wrap').find('.zl-wrap').each(function(){
				if($(this).height()>zlHeight) {
					zlHeight = $(this).height();
				}
			});
			$('.content-inner-wrap')
				.height(476 + zlHeight);
			$('#zone-navigation').show();
		},
		leave: function() {
			$('.widget-outer-wrap').show();
			$('.fwidth').width('auto');
			// $('#map').css({
			// 	'height': '476px',
			// 	'position': 'static'
			// });
		}
	},
	lga: {
		enter: function (){
			$('.profile-data-wrap').show();
			$('#zone-navigation').hide();
			// SetResizer is defiend in application.js
			//   its purpose is to trigger "full-height" whenever the page is resized.
			//   it has some weird side-effects on mobile browsers.
			SetResizer(jQuery, ".content-inner-wrap", "#header, #menu", 15);
			var mb = mapBar()
					.elem.show();
//					.find('tr').append($('<td />').html($('<a />', {'href':'#'}).text("hi").click(function(){console.log(this); return false;})));
		},
		leave: function(){
			$('.profile-data-wrap').hide();
			mapBar().elem.hide();
		}
	}
};

var currentMode;
function setMode(mode) {
	if(currentMode==mode) { return; }
	currentMode!==undefined && modes[currentMode].leave
					.apply(this, [].concat(arguments));
	currentMode = mode;
	modes[currentMode].enter.apply(this, [].concat(arguments))
}

//a temporary link back to the home page.
descriptionClick($('<a />', {'href':'/~'})
	.addClass('home-link')
	.addClass('hover-unhide')
	.text('*')
	.css({
		position: 'absolute',
		top: 5,
		left: 5,
		color: '#fff',
		textDecoration: 'none'
	})
	.appendTo('#header'));

$(function(){
	var dashboard = $.sammy(function(){
		function createTitleForLga(state, lga) {
			return $("<span />").text("LGA: ")
				.append($("<span />", {'class': 'state-name'}).text(state))
				.append($("<span />").text(' Â» '))
				.append($("<span />", {'class': 'lga-name'}).text(lga));
		}
		
		//preparing the list of layers for "launchOpenLayers"
		var _layerIdsAndNames = $.map(layerData, function(layer, i){
			return [[layer.name, layer.slug]]
		});
		var layerIdsAndNames = [["Nigeria", "nigeria_base"]].concat(_layerIdsAndNames);
		this.get(pageRootUrl, function(){
			$('#map').css({
				'height': '476px',
				'position': 'static'
			});
			setMode('home');
			setTitle($("<span />", {'text': 'Home'}));
			$('<div />')
				.addClass('home-map')
				.appendTo('#map')
				.width(680)
				.height(476)
				.css({'position':'absolute'})
			var mapNavWrap = $('<div />')
				.addClass('home-map-nav')
				.appendTo('#map')
				.height(476)
				.css({
					'border': '1px solid #bbb',
					'padding-left': '685px'
				});
			(function activateNavigation(){
					var nav = $('#zone-navigation');
					if(!nav.hasClass('activated')) {
						nav.delegate('.lga-list a', 'click', function(){
							//sammy is not being friendly right now, so I'm going around it.
							window.location = this.href;
							return false;
						});
						nav.delegate('a.state-link', 'click', function(){
							var ul = $(this).parents('li')
									.eq(0)
									.find('ul');
							if(ul.hasClass('showing')) {
								nav.find('.showing').removeClass('showing');
							} else {
								nav.find('.showing').removeClass('showing');
								ul.addClass('showing')
							}
						});
						nav.find('.state-link').each(function(){
							var lgaCount = $(this).data('lgaCount');
							if(lgaCount!==undefined) {
								$('<span />')
									.text(' ('+lgaCount+')')
									.addClass('lga-count')
									.addClass(lgaCount===0 ? 'zero' : undefined)
									.appendTo(this);
							}
						});
						nav.addClass('activated')
							.show();
					}
				})();
			$('<div />')
				.addClass('map-loading-message')
				.appendTo('#map')
				.hide();

			launchOpenLayers({
				defaultLayer: '',
				layers: layerIdsAndNames,
				loadingMessage: 'Please be patient while this map loads',
				loadingElem: '.map-loading-message',
				layerSwitcher: false,
				elem: '.home-map'
			})(function(){
//				mapNavWrap.empty();
				var layerNav = $('<div />')
						.addClass('layer-nav')
						.appendTo(mapNavWrap);
				var layerDescription = $('<div />')
						.addClass('layer-description')
						.appendTo(mapNavWrap);
				var that = this;
				(function createLayerSwitcher(){
					var s = $('<select />');
					$.each(layerData.sort(function(a,b){
						if(a.display_order===b.display_order) {return 0;}
						return a.display_order > b.display_order ? 1 : -1;
					}), function(){
						$('<option />')
							.text(this.name)
							.attr('value', this.slug)
							.appendTo(s);
					});
					s.change(function(){
						var layerId = $(this).val();
						var OLlayer = that.mapLayers[layerId];
						if(OLlayer!==undefined) {
							that.map.setBaseLayer(OLlayer);
						}
						var layerObj;
						$.each(layerData, function(){
							if(this.slug===layerId) {
								layerObj = this;
							}
						});
						if(!!layerObj) {
							layerDescription.empty();
							var hideBox = true;
							var description = $('<p />')
								.appendTo(layerDescription);
							if(!!layerObj.description) {
								description.text(layerObj.description);
								hideBox = false;
							}
							if(!!layerObj.data_source) {
								hideBox = false;
								$('<span />')
									.text(' (' + layerObj.data_source + ')')
									.css({'font-style':'italic'})
									.appendTo(description);
							}
						}
						})
						.appendTo(layerNav);
				})();
			});
		});
		
		function addToggleLinks(){
			var profileDataLink = $('<a />', {'href':'#'})
					.addClass('toggle-button')
					.text('[LGA]')
					.click(function(e){
						$('.profile-data').toggleClass('hidden')
						profileDataLink.toggleClass('hidden');
						return false;
					});
			var facilityTableLink = $('<a />', {'href':'#'})
					.addClass('toggle-button')
					.text('[FACILITIES]')
					.click(function(e){
						$('#lga-facilities-table').toggleClass('hidden');
						facilityTableLink.toggleClass('hidden');
						return false;
					});
			var gapAnalysisLink = $('<a />', {href: '#'})
					.addClass('toggle-button')
					.text('[GAP ANALYSIS]')
					.click(function(e){
						$('.gap-analysis-table-wrap')
							.addClass('toggleable')
							.toggleClass('hidden');
						gapAnalysisLink.toggleClass('hidden');
						return false;
					});
			$('#header .title')
					.append(profileDataLink)
					.append(gapAnalysisLink)
					.append(facilityTableLink);
		}
		function showLgaAndSector(lgaId, fullSectorId) {
			setMode('lga');
			lga.loadData(lgaId, function(){
				this.buildTable = true;
				setTitle(createTitleForLga(this.stateName, this.lgaName));
				fullSectorId !== undefined && this.trigger('select-sector', {fullSectorId: fullSectorId, viewLevel: 'facility'});
				//addToggleLinks();
			});
		}
		this.get(pageRootUrl + ":lga/(.+)", function(){
			var lgaId = this.params.lga;
			this.params.splat.length !== 1 && warn("Sammy needs some help selecting a sector.");
			var fullSectorId = this.params.splat[0];
			showLgaAndSector(lgaId, fullSectorId);
		})
		this.get(pageRootUrl + ":lga", function(){
			var lgaId = this.params.lga;
			$('#zone-navigation').hide();
			showLgaAndSector(lgaId);
/*			lga.loadData(lgaId,
							function(){
								this.buildTable = true;
								var t = createTitleForLga(this.stateName, this.lgaName);
								setTitle(t);
								addToggleLinks();
							}); */
		});
	});
	
	window._dashboard = dashboard;
	dashboard.run();
});

-->
</script>
{% endblock %}
