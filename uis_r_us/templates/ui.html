{% extends "ui_base.html" %}
{% block head %}
<link rel="stylesheet" href="/static/css/widget-wrap.css" type="text/css" media="all" charset="utf-8">
<style type="text/css" media="screen">
	.content-inner-wrap {
		position: relative;
	}
	.resizing-map {
		position: absolute;
		top: 0;
		left: 0;
		height: 100%;
		width: 100%;
		z-index: 10;
	}
	.overmap-content {
		z-index: 11;
		position: absolute;
		top: 0;
		left: 0;
		height: 100%;
		width: 100%;
	}
</style>
{% endblock %}
{% block content %}
<div class='content-inner-wrap'>
<div class='overmap-content'>
<script type="text/javascript" charset="utf-8">
<!--
//add widget callbacks to this array
var _widgetCallbacks = [];
function widget(cb) { _widgetCallbacks.push(cb); }
-->
</script>
{% include 'widget_includes.html' %}
</div>
<div id="map" class="resizing-map"></div>
</div>
{% endblock %}
{% block js %}
<script src="/static/js/launch-open-layers.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" charset="utf-8">
<!--

var facilityDataStuff = (function(){
	var printDebugStats = true;
	function warn() {
		if(console !== undefined && console.warn !== undefined) {
			console.warn(arguments); throw(arguments[0]);
		}
	}
	function log() {
		if(console !== undefined && console.log !== undefined) {
			console.log(arguments);
		}
	}
	function happy() {console.log(arguments);}
	function processPassedData(passedData){
		var data, sectors, noLatLngs=0;
		facilitySectorSlugs = [];
		
		passedData === undefined && warn("No data was passed to the page", passedData);
		if(!passedData.sectors || !passedData.sectors.length) {
			warn("data must have 'sectors' list.")
		}
		(function validateSectors(s){
			$(s).each(function(){
				this.name === undefined && warn("Each sector needs a name.", this);
				this.slug === undefined && warn("Each sector needs a slug.", this);
				this.columns instanceof Array || warn("Sector columns must be an array.", this);
				
				(this.slug in facilitySectorSlugs) && warn("Slugs must not be used twice", this);
				facilitySectorSlugs.push(this.slug);
				
				$(this.columns).each(function(i, val){
					var name = val.name;
					var slug = val.slug;
					
					name === undefined && warn("Each column needs a slug", this);
					slug === undefined && warn("Each column needs a name", this);
				});
			});
			sectors = s;
		})(passedData.sectors)
		passedData.data === undefined && warn("Data must be defined", this);
		
		(function validateData(d) {
			d.length === undefined && warn("Data must be an array", this);
			
			$(d).each(function(i, row){
				this.sector === undefined && warn("Each row must have a sector", this);
				if(this.latlng === undefined) {
					//some points don't have latlngs but should show up in tables.
					noLatLngs++;
				} else {
					(this.latlng instanceof Array) || warn("LatLng must be an array", this);
					(this.latlng.length === 2) || warn("Latlng must have length of 2", this);
					
				}
				
				(!!~facilitySectorSlugs.indexOf(this.sector)) || warn("Sector must be in the list of sector slugs:", {
					sector: this.sector,
					sectorSlugs: facilitySectorSlugs,
					row: this
				});
			});
		})(passedData.data);
		
		(function processData(rawData){
			var uidCounter = 0;
			var list = {};
			var groupedList = {};
			var sectorNames = [];
			$.each(rawData, function(i, pt){
				if(pt.uid===undefined) { pt.uid = 'uid'+i; }
				if(!~sectorNames.indexOf(pt.sector)) {
					sectorNames.push(pt.sector);
					groupedList[pt.sector] = [];
				}
				groupedList[pt.sector].push(pt.uid);
				list[pt.uid]=pt;
			});
			data = {
				bySector: groupedList, //sector-grouped list of IDs, for the time being
				list: list //the full list (this is actually an object where the keys are the unique IDs.)
			};
		})(passedData.data);
		
		printDebugStats && (function printTheDebugStats(){
			log("" + sectors.length + " sectors were loaded.");
			var placedPoints = 0;
			$(sectors).each(function(){
				if(data.bySector[this.slug] === undefined) {
					log("!->: No data loaded for "+this.name);
				} else {
					var ct = data.bySector[this.slug].length;
					placedPoints += ct;
					log("   : "+this.slug+" has "+ct+" items.", this);
				}
			});
			log(noLatLngs + " points had no coordinates")
		})();
		
		window.facilityData = data;
		window.facilitySectors = sectors;
	}
	return processPassedData;
})()

$('.content-inner-wrap').css({'padding':0})
var pageRootUrl = "/ui/";
$(function(evt){
	var env = {
		launchers: {},
		callbacks: {},
		addCallback: function(k, fn){
			if(this.callbacks[k]===undefined) {this.callbacks[k]=[]}
			this.callbacks[k].push(fn);
		}
	};
	(function setModeBinders(body){
		var mode;
		body.bind('mode-change', function(evt, data){
			if(mode !== data.mode) {
				mode = data.mode;
//				console.log("Changing mode to "+data.mode);
			}
			var fv1 = $.getJSON('/facilities/zurmi');
			var fvDefs = $.getJSON('/facility_variables');
			$.when(fv1, fvDefs).done(function(lgaRequest, varDataReq){
				var facilityData = lgaRequest[0];
				var variableDefs = varDataReq[0].sectors;
				var facilityDataARr = [];
				$.each(facilityData, function(k, v){
					v.uid = k;
					facilityDataARr.push(v);
				});
				facilityDataStuff({sectors: variableDefs, data: facilityDataARr});
			});
			// launchOpenLayers(function(){
			// 	console.log("HERE!!", this.map)
			// });
		})
	})($('body'));
	
	$(_widgetCallbacks).each(function(i, w){
		w.call(env);
	});
	function setPageMode(t) {$('body').trigger('mode-change', {mode: t});}
	var dashboard = $.sammy(function(){
		this.get(pageRootUrl, function(){
			setPageMode("country");
		});
		this.get(pageRootUrl + "lga/", function(){
			setPageMode("lga");
		});
	});
	//do we want this in the global scope?
	window._dashboard = dashboard;
	dashboard.run();
	function runCallbacksOn(cbs, obj) {$(cbs).each(function(i, cb){cb.call(obj)})}
	function launchMap(cbArr) {
		var map = {};
		//load map...
		runCallbacksOn(env.callbacks.map, map);
	}
	if(env.launchers.map) {
		launchMap();
	}
});

var SetResizer = (function($, resizeSelector, excludeSelector, extraPadding){
	var resizeElem = $(resizeSelector),
		excludeElem = $(excludeSelector);

	function ResizePage(){
		var windowHeight = $(window).height(),
			totalHeight = windowHeight - extraPadding;

		excludeElem.each(function(){totalHeight -= $(this).height();});
		resizeElem.css({'height':totalHeight})
	}
	$(window).resize(ResizePage);

	$(function(){
		resizeElem.css({'overflow':'auto'});
		$(document.body).css({'overflow':'hidden'})
		$(window).trigger('resize')
	});
});
(function($){
	$.fn.thinButton = function(){
		this.button();
		$('span.ui-button-text', this).css({'padding':'1px 5px'});
		return this;
	}
})(jQuery);
SetResizer(jQuery, ".content-inner-wrap", "#header, #menu", 15);
-->
</script>
{% endblock %}