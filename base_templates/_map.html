<div class="map-wrap">
</div>
<script type="text/javascript" charset="utf-8">
	
	var objs = {};
	
	objs.surveyor = [
		{
			name: 'bob',
			id: 1
		},
		{
			name: 'sven',
			id: 2
		}
		]
	
	var surveys = {{surveys|safe}}
	objs.survey = surveys;
	
	objs.date = [
		{
			name: "10",
			id: 1
		},
		{
			name: "12-23-10",
			id: 2
		}
		]
	
	function findObj(objType, obj) {
		var result;
		$(objs[objType]).each(function(){
			if(this.id==obj) {
				result = this
			}
		});
		if(!result) {return null;}
		return result;
	}
	
	function filterPoints(district, objType, obj) {
		return []
	}
	
	var District = (function(){
		function _District(data) {
			$.extend(this, data);
			var c = this.coords.split(",");
			this.gps = {
				lat: c[0],
				lng: c[1]
			}
		}
		_District.prototype = new Mappable();
		_District.prototype.GLatLng = function(){
			var ll = this.coords.split(",");
			return new google.maps.LatLng(ll[0],ll[1]);
		}
		return _District;
	})(jQuery)
	
	var districts = $({{districts|safe}}).map(function(){return new District(this)})
	function findDistrict(did) {var result; $(districts).each(function(){if(did==this.id){result=this}}); return result;}
	
	var _map;
	var filters = "survey surveyor date".split(" ")
	
	var _filters, _values;
	function getFilters() {
		if(!_filters) {
			_values = _list.getVarieties();
			_filters = [];
			$.each(_values, function(k, v) {
				_filters.push(k);
			})
		}
		return {
			'filters': _filters,
			'values': _values
		}
	}
	
	var mapByOpts = {
		lga: "LGA",
		surveyor: "Surveyor",
		survey_type: "Survey Type"
	};
	
	function urlForMapState(hsh) {
		var str = "#/map";
		if(hsh.district) {
			if(hsh.district.id) {
				str+= "/"+hsh.district.id;
			} else {
				str+= "/"+hsh.district;
			}
		} else {
			return str;
		}
		if(hsh.filter) {
			str += "/by/"+hsh.filter
		} else {
			return str;
		}
		if(hsh.obj) {
			str += "/"+hsh.obj;
		}
		return str;
	}
	
	(function(){
		var mapStorage = new Sammy.Store({name:'mapStorage',element:'#map',type:'local'}),
			mapWrap = false,
			mapState = {},
			empty = (null==mapStorage.get('first'));
		
		function changeMapState(ms, opts) {
			//temp
			return $.extend(ms, opts);
		}
		
		dashboard.setMapElem("#map > div");
		
		dashboard.get("#/map", function(context){			
	        this.title("Map");
			this.switchTo("map");
			mapState = changeMapState(mapState, {
				scale: 'country',
				district: null,
				filter: null
			})
			this.Map(function(){
				this.nigeriaCenter();

				this.key({clear:true});
				this.addSelector({list:[],text:"Select District"}, function(selector){
					var main = $("<option />", {value:'all'}).html("Nigeria");
					var big = $("<optgroup />", {'label':"Selector"}).html(main);
					
					var subdistricts = $("<optgroup />", {'label':"LGA"});
					$(districts).each(function(){
                        var opt = $("<option />", {value: this.id}).html(this.name)
	                    subdistricts.append(opt);
	                })
	                selector.append(big);
					selector.append(subdistricts);
					
					selector.val('all');
					selector.change(function(){
						if($(this).val()=='all') {
							dashboard.setLocation("#/map");
						} else {
							dashboard.setLocation(urlForMapState({district: $(this).val()}));
						}
					});
				});
				
//				this.displayPoints()
//				this.addMapTypeSelector();
				
				this.debug(mapState);
			})
	    });
		
		dashboard.get("#/map/:district", function(){
			var district = findDistrict(this.params['district']);
			
			this.title("Map "+district.name);
			this.switchTo("map");
			
			mapState = changeMapState(mapState, {
				scale: 'district',
				district: district.name,
				filter: null
			});

			this.Map(function(){
				this.mapCenter(district.GLatLng(), {'zoom': 8})
				this.key({clear:true});
				
				this.addSelector({list:[],text:"District"}, function(selector){
					var main = $("<option />", {value:'all'}).html("Nigeria");
					var big = $("<optgroup />", {'label':"Selector"}).html(main);
					
					var subdistricts = $("<optgroup />", {'label':"LGA"});
					$(districts).each(function(){
                        var opt = $("<option />", {value: this.id}).html(this.name)
	                    subdistricts.append(opt);
	                })
	                selector.append(big);
					selector.append(subdistricts);
					
					selector.val(district.id);
					selector.change(function(){
						if($(this).val()=='all') {
							dashboard.setLocation("#/map");
						} else {
							dashboard.setLocation(urlForMapState({district: $(this).val()}));
						}
					});
				});
				// this.divider();
				this.addSelector({list:getFilters().filters,text:"Filter"}, function(selector){
					selector.prepend("<option />", {'value':'all'});
					selector.val('all');
					selector.change(function(){
						var cval = $(this).val();
						if(cval=='all'){cval=null;}
						
						dashboard.setLocation(urlForMapState({
							district: district,
							filter: cval
						}));
					})
				})
//				this.addMapTypeSelector();
				
				
				var showMe = _list.filter('district_id', district.id);
				this.displayPoints(showMe)
				var curWindow = showMe.latLngWindow();
				if(curWindow) {
					this.setMapCenter(curWindow.lat, curWindow.lng, curWindow)
				}
				
				this.debug(mapState);
			})
		})
		
		
		dashboard.get("#/map/:district/by/surveyor/?(:obj)?", function(){
			var district = findDistrict(this.params['district']),
				obj = this.params['obj'],
				surveyor = obj;

			this.switchTo("map");
			if(!surveyor) {
				this.title("Map "+district.name+" by Surveyor")
			} else {
				this.title("Map "+district.name+" by Surveyor: "+surveyor)
			}
			mapState = changeMapState(mapState, {
				scale: 'district',
				district: district.name,
				filter: 'surveyor',
				xyz: surveyor
			});
			this.Map(function(){
				this.mapCenter(district.GLatLng(), {'zoom': 8})
				this.key({clear:true});
				
				this.addSelector({list:[],text:"District"}, function(selector){
					var main = $("<option />", {value:'all'}).html("Nigeria");
					var big = $("<optgroup />", {'label':"Selector"}).html(main);
					
					var subdistricts = $("<optgroup />", {'label':"LGA"});
					$(districts).each(function(){
                        var opt = $("<option />", {value: this.id}).html(this.name)
	                    subdistricts.append(opt);
	                })
	                selector.append(big);
					selector.append(subdistricts);
					
					selector.val(district.id);
					selector.change(function(){
						if($(this).val()=='all') {
							dashboard.setLocation("#/map");
						} else {
							dashboard.setLocation(urlForMapState({district: $(this).val()}));
						}
					});
				});
//				this.divider();
				
				this.addSelector({list:getFilters().filters,text:"Filter"}, function(selector){
					var all = $("<option />", {value: 'all'});
					selector.prepend(all);
					if(!mapState.filter){selector.val('all')}else{selector.val(mapState.filter)}
					selector.change(function(){
						var cval = $(this).val();
						if(cval=='all'){cval=null;}
						
						dashboard.setLocation(urlForMapState({
							district: district,
							filter: cval
						}));
					})
				});
				
				
//				this.divider();
				
				var showMe = _list.filter('district_id', district.id);
				var surveyorList = showMe.getVarieties()['surveyor']
				
				this.addSelector({list:[],text:"Surveyor"}, function(selector){
					var all = $("<option />", {value: 'all'});
					var filterGroup = $("<optgroup />", {label:'Filter'})
					$(surveyorList).each(function(){
						filterGroup.append($("<option />").html(String(this)))
					})
					selector.append(all);
					selector.append(filterGroup);
					selector.val(surveyor);
					selector.change(function(){
						var objec = $(this).val();
						if(objec=="all") {
							objec=false
						}
						dashboard.setLocation(urlForMapState({
							district: district,
							filter: 'surveyor',
							obj: objec
						}));
					})
				});
				
				if(surveyor && surveyor!=="undefined") {
					showMe = showMe.filter('surveyor', surveyor);
				}
				this.displayPoints(showMe)
				var curWindow = showMe.latLngWindow();
				if(curWindow) {
					this.setMapCenter(curWindow.lat, curWindow.lng, curWindow)
				}
				
				this.debug(mapState);
			})
		});
		

		dashboard.get("#/map/:district/by/survey/?(:obj)?", function(){
			var district = findDistrict(this.params['district']),
				obj = this.params['obj'],
				survey = obj;

			this.switchTo("map");
			if(!survey) {
				this.title("Map "+district.name+" by Survey")
			} else {
				this.title("Map "+district.name+" by Survey: "+survey.toUpperCase())
			}
			mapState = changeMapState(mapState, {
				scale: 'district',
				district: district.name,
				filter: "survey",
				xyz: survey
			})
			this.Map(function(){
				this.mapCenter(district.GLatLng(), {'zoom': 8})
				this.key({clear:true});
				
				
				this.addSelector({list:[],text:"District"}, function(selector){
					var main = $("<option />", {value:'all'}).html("Nigeria");
					var big = $("<optgroup />", {'label':"Selector"}).html(main);
					
					var subdistricts = $("<optgroup />", {'label':"LGA"});
					$(districts).each(function(){
                        var opt = $("<option />", {value: this.id}).html(this.name)
	                    subdistricts.append(opt);
	                })
	                selector.append(big);
					selector.append(subdistricts);
					
					selector.val(district.id);
					selector.change(function(){
						if($(this).val()=='all') {
							dashboard.setLocation("#/map");
						} else {
							dashboard.setLocation(urlForMapState({district: $(this).val()}));
						}
					});
				});
//				this.divider();
				
				this.addSelector({list:getFilters().filters,text:"Filter"}, function(selector){
					var all = $("<option />", {value: 'all'});
					selector.prepend(all);
					
					if(!mapState.filter){selector.val('all')}else{selector.val(mapState.filter)}
					
					selector.change(function(){
						var cval = $(this).val();
						if(cval=='all'){cval=null;}
						
						dashboard.setLocation(urlForMapState({
							district: district,
							filter: cval
						}));
					})
				});
				
//				this.divider();
				var showMe = _list.filter('district_id', district.id);
				var surveyList = showMe.getVarieties()['survey']
				
				this.addSelector({list:surveyList,text:"Survey"}, function(selector){
					selector.prepend($("<option />", {'value':'all'}))
					selector.val(survey);
					selector.change(function(){
						var oVal = $(this).val();
						if(oVal=='all') {oVal=null;}
						dashboard.setLocation(urlForMapState({
							district: district,
							filter: 'survey',
							obj: oVal
						}));
					})
				});
				
				if(survey && survey!=="undefined") {
					showMe = showMe.filter('survey', survey);
				}
				this.displayPoints(showMe)
				var curWindow = showMe.latLngWindow();
				if(curWindow) {
					this.setMapCenter(curWindow.lat, curWindow.lng, curWindow)
				}

				this.debug(mapState);
			})
		});


		dashboard.get("#/map/:district/by/date/?(:obj)?", function(){
			var district = findDistrict(this.params['district']),
				obj = this.params['obj'],
				date = this.params['obj'];

			this.switchTo("map");
			
			if(!date) {
				this.title("Map "+district.name+" by Date")
			} else {
				this.title("Map "+district.name+" by Date: "+date)
			}
			
			mapState = changeMapState(mapState, {
				scale: 'district',
				district: district.name,
				filter: "date",
				xyz: date
			})
			this.Map(function(){
				this.mapCenter(district.GLatLng(), {'zoom': 8})
				this.key({clear:true});
				
				this.addSelector({list:[],text:"District"}, function(selector){
					var main = $("<option />", {value:'all'}).html("Republic of Nigeria");
					var big = $("<optgroup />", {'label':"State View"}).html(main);
					
					var subdistricts = $("<optgroup />", {'label':"LGA View"});
					$(districts).each(function(){
                        var opt = $("<option />", {value: this.id}).html(this.name)
	                    subdistricts.append(opt);
	                })
	                selector.append(big);
					selector.append(subdistricts);
					
					selector.val(district.id);
					selector.change(function(){
						if($(this).val()=='all') {
							dashboard.setLocation("#/map");
						} else {
							dashboard.setLocation(urlForMapState({district: $(this).val()}));
						}
					});
				});
//				this.divider();
				
				this.addSelector({list:getFilters().filters,text:"Filter"}, function(selector){
					
					selector.prepend($("<option />", {value: 'all'}));
					
					if(!mapState.filter){selector.val('all')}else{selector.val(mapState.filter)}
					
					selector.change(function(){
						var cval = $(this).val();
						if(cval=='all'){cval=null;}
						dashboard.setLocation(urlForMapState({
							district: district,
							filter: cval
						}));
					})
				})
				
				
				var showMe = _list.filter('district_id', district.id);
				this.addSelector({list:showMe.getVarieties().date,text:"Date"}, function(selector){

					selector.prepend($("<option />", {value: 'all'}));
					selector.val(date);
					selector.change(function(){
						var thisVal = $(this).val();
						if(thisVal=="all") {
							thisVal=false;
						}
						dashboard.setLocation(urlForMapState({
							district: district,
							filter: 'date',
							obj: thisVal
						}));
					})
				});

				if(date && date!=='undefined') {
					showMe = showMe.filter('date', date);
				}
				
				this.displayPoints(showMe)
				var curWindow = showMe.latLngWindow();
				if(curWindow) {
					this.setMapCenter(curWindow.lat, curWindow.lng, curWindow)
				}
				
				this.debug(mapState);
			})
		});




		dashboard.get("#/map/survey/:survey_id", function(){
			this.Map(function(){
//				this.map.setCenter();
			})
		})
	})();
	function findActivityById(aid) {
		for(var i in _list) {
			if(activityData[i].id==aid) {
				return activityData[i];
			}
		}
	}
</script>

<script type="text/javascript" charset="utf-8">
/*-- 
- This structure works, for now.
--*/
var SubmissionList, SubmissionPoint;
(function($){
	function _SubmissionList(arr){
		this.addPoints(arr)
	}
	_SubmissionList.prototype = new Array();
	$.extend(_SubmissionList.prototype, {
		addPoint: function(point){
			if(point instanceof _SubmissionPoint) { this.push(point)
			} else {
				this.push(new _SubmissionPoint(point))
			}
		},
		addPoints: function(points){
			var _Sl = this;
			$(points).each(function(){_Sl.addPoint(this)})
		}
	})
	
	function _SubmissionPoint(o){$.extend(this, o)}
	window.SubmissionList = _SubmissionList;
})(jQuery);

/*--
		sortBy: function(q){
			return this.points.sort(function(a, b){
				return a[q] < b[q] ? -1 : a[q] > b[q] ? 1 : 0
			})
		},
		groupBy: function(q){
			var _k, _output = {};
			$(this.points).each(function(){
				_k = String(this[q]);
				if(typeof(_output[_k])=='undefined') {_output[_k]=[]}
				_output[_k].push(this);
			});
			return _output;
		},
            if(this.gps) {
                this.gpoint = new google.maps.LatLng(this.gps.lat, this.gps.lng);
                this.gmarker = new google.maps.Marker({
                    position: this.gpoint,
                    icon: this.icon(),
                    title: this.title
                })
            }
        icon: function(){
            return '/site-media/images/geosilk/flag_'+markerImages[this.survey_type]+'.png';

                google.maps.event.addListener(this.gmarker, 'click', function(){
                    $.fancybox({
                        padding: 5,
                        href: _image,
                        title: _title,
                        transitionIn: 'elastic',
                        transitionOut: 'elastic'
                    })

        popupImage: function(){
            if(this.hasImage()) {
                $.fancybox({
        			'padding'		: 5,
        			'href'			: this.images[0],
        			'title'   		: this.title,
        			'transitionIn'	: 'elastic',
        			'transitionOut'	: 'elastic'
        		});

--*/
</script>