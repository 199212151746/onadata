<div class="map-wrap">
</div>
<script type="text/javascript" charset="utf-8">
	
	
	var MapPopup = (function(){
		var showing = false;
		var wrapElem;
		function show(elem){
			if(!wrapElem) {
				wrapElem = $("#map #m-key");
			}
			if(showing) {
				$(showing).dialog('close');
				$(showing).remove();
			}
			$(elem).dialog({
				resizable: false,
				width: 600
			});
			showing = elem;
		}
		return show;
	})()
	
	var objs = {};
	
	var surveys = {{surveys|safe}}
	objs.survey = surveys;

	function findObj(objType, obj) {
		var result;
		$(objs[objType]).each(function(){
			if(this.id==obj) {
				result = this
			}
		});
		if(!result) {return null;}
		return result;
	}
	
	var District = (function(){
		function _District(data) {
			$.extend(this, data);
			var c = this.coords.split(",");
			this.gps = {
				lat: c[0],
				lng: c[1]
			}
		}
		_District.prototype = new Mappable();
		_District.prototype.GLatLng = function(){
			var ll = this.coords.split(",");
			return new google.maps.LatLng(ll[0],ll[1]);
		}
		_District.prototype.ensureKmlLoaded = function(map){
			if(!this.kmlLayer) {
				this.kmlLayer = new google.maps.KmlLayer(this.kml+"?a", {
					map: map,
//					suppressInfoWindows: true,
					preserveViewport: true
				});
			}
		}
		return _District;
	})(jQuery)
	
	var districts = $({{districts|safe}}).map(function(){return new District(this)})
	function findDistrict(did) {var result; $(districts).each(function(){if(did==this.id){result=this}}); return result;}
	
	var _map;
	var filters = "survey surveyor date".split(" ")
	
	var _filters, _values;
	function getFilters(_list) {
		if(!_filters) {
			_values = _list.getVarieties();
			_filters = [];
			$.each(_values, function(k, v) {
				_filters.push(k);
			})
		}
		return {
			'filters': _filters,
			'values': _values
		}
	}
	
	var mapByOpts = {
		lga: "LGA",
		surveyor: "Surveyor",
		survey_type: "Survey Type"
	};
	
	function urlForMapState(hsh) {
		var str = "#/map";
		if(hsh.district) {
			if(hsh.district.id) {
				str+= "/"+hsh.district.id;
			} else {
				str+= "/"+hsh.district;
			}
		} else {
			return str;
		}
		if(hsh.filter) {
			str += "/by/"+hsh.filter
		} else {
			return str;
		}
		if(hsh.obj) {
			str += "/"+hsh.obj;
		}
		return str;
	}
	
	(function(){
		var mapState = {};
		
		function changeMapState(ms, opts) {
			return $.extend(ms, opts);
		}
		
		dashboard.setMapElem("#map > div");
		
		dashboard.get("#/map", function(context){			
			this.switchTo("map", {title: 'Map'});
			mapState = changeMapState(mapState, {
				scale: 'country',
				district: null,
				filter: null
			})
			this.addMapLoadCallback(function(){
				this.ensureDistrictKmls();
			})
			this.Map(function(){
				__map = this.map;
				this.nigeriaCenter();

				this.key({clear:true});
				this.addSelector({list:[],text:"Select District"}, function(selector){
					var main = $("<option />", {value:'all'}).html("Nigeria");
					var big = $("<optgroup />", {'label':"Selector"}).html(main);
					
					var subdistricts = $("<optgroup />", {'label':"LGA"});
					$(districts).each(function(){
                        var opt = $("<option />", {value: this.id}).html(this.name)
	                    subdistricts.append(opt);
	                })
	                selector.append(big);
					selector.append(subdistricts);
					
					selector.val('all');
					selector.change(function(){
						if($(this).val()=='all') {
							dashboard.setLocation("#/map");
						} else {
							dashboard.setLocation(urlForMapState({district: $(this).val()}));
						}
					});
				});
				var _MapEnv = this;
				WithActivityList(function(){
					_MapEnv.display([], {hideList: this.list})
				})
			})
	    });
		//end #/map
		
		
		dashboard.get("#/map/:district", function(){
			var district = findDistrict(this.params['district']);
			
			this.switchTo("map", {title:"Map "+district.name});
			
			mapState = changeMapState(mapState, {
				scale: 'district',
				district: district.name,
				filter: null
			});

			this.Map(function(){
				this.mapCenter(district.GLatLng(), {'zoom': 8})
				this.key({clear:true});
				
				this.addSelector({text:"District"}, function(selector){
					var main = $("<option />", {value:'all'}).html("Nigeria");
					var big = $("<optgroup />", {'label':"Selector"}).html(main);

					var subdistricts = $("<optgroup />", {'label':"LGA"});
					$(districts).each(function(){
                        var opt = $("<option />", {value: this.id}).html(this.name)
	                    subdistricts.append(opt);
	                })
	                selector.append(big);
					selector.append(subdistricts);
					
					selector.val(district.id);
					
					selector.change(function(){
						if($(this).val()=='all') {
							dashboard.setLocation("#/map");
						} else {
							dashboard.setLocation(urlForMapState({district: $(this).val()}));
						}
					});
				});
				
				var Showing, _MapEnv = this;
				WithActivityList(function(list){
					Showing = list.filter('district_id', district.id);

					_MapEnv.addSelector({list:getFilters(list).filters,text:"Filter"}, function(selector){
						selector.prepend("<option />", {'value':'all'});
						selector.val('all');
						selector.change(function(){
							var cval = $(this).val();
							if(cval=='all'){cval=null;}

							dashboard.setLocation(urlForMapState({
								district: district,
								filter: cval
							}));
						})
					});
					
					_MapEnv.display(Showing, {
						hideList: list,
						boundWindow: true
					})
				})
			})
		})
		//end #/map/district
		
		dashboard.get("#/map/:district/by/surveyor/?(:obj)?", function(){
			var district = findDistrict(this.params['district']),
				filterItem = this.params.obj,
				surveyor = this.params.obj;

			var title;
			if(surveyor && surveyor !=='undefined') {
				title = "Map "+district.name+" by Surveyor";
			} else {
				title = "Map "+district.name+" by Surveyor: "+surveyor;
			}
			this.switchTo("map", {title: title});
			mapState = changeMapState(mapState, {
				scale: 'district',
				district: district.name,
				filter: 'surveyor',
				xyz: surveyor
			});
			this.Map(function(){
				this.mapCenter(district.GLatLng(), {'zoom': 8})
				this.key({clear:true});
				
				this.addSelector({list:[],text:"District"}, function(selector){
					var main = $("<option />", {value:'all'}).html("Nigeria");
					var big = $("<optgroup />", {'label':"Selector"}).html(main);
					
					var subdistricts = $("<optgroup />", {'label':"LGA"});
					$(districts).each(function(){
                        var opt = $("<option />", {value: this.id}).html(this.name)
	                    subdistricts.append(opt);
	                })
	                selector.append(big);
					selector.append(subdistricts);
					
					selector.val(district.id);
					selector.change(function(){
						if($(this).val()=='all') {
							dashboard.setLocation("#/map");
						} else {
							dashboard.setLocation(urlForMapState({district: $(this).val()}));
						}
					});
				});

				var Showing, _MapEnv = this;
				WithActivityList(function(list){
					_MapEnv.addSelector({list:getFilters(list).filters, text:"Filter"}, function(selector){
						var all = $("<option />", {value: 'all'});
						selector.prepend(all);
						if(!mapState.filter){ selector.val('all'); } else { selector.val(mapState.filter); }
						
						selector.change(function(){
							var cval = $(this).val();
							if(cval=='all'){cval=null;}
							dashboard.setLocation(urlForMapState({
								district: district,
								filter: cval
							}));
						})
					})
					
					Showing = list.filter('district_id', district.id),
						surveyorList = Showing.getVarieties().surveyor;
					
					_MapEnv.addSelector({text:"Surveyor"}, function(selector){
						var opts = {
							all: $("<option />", {value: 'all'}),
							filterGroup: $("<optgroup />", {label: 'Filter'})
						};
						$(surveyorList).each(function(){
							opts.filterGroup.append($("<option />").html(String(this)));
						});
						selector.append(opts.all);
						selector.append(opts.filterGroup);
						selector.val(filterItem || 'all');
						selector.change(function(){
							var sval = $(this).val();
							if(sval=='all'){sval=null}
							dashboard.setLocation(urlForMapState({
								district: district,
								filter: 'surveyor',
								obj: sval
							}))
						})
					});
					
					if(filterItem && filterItem!=='undefined') {
						Showing = Showing.filter('surveyor', filterItem)
					}
					_MapEnv.display(Showing, {
						hideList: list,
						boundWindow: true
					});
				})
			})
		});
		//end #/map/district/by/surveyor/*
		
		dashboard.get("#/map/:district/by/survey/?(:obj)?", function(){
			var district = findDistrict(this.params['district']),
				obj = this.params['obj'],
				survey = obj;
			
			var title;
			if(survey && survey !== 'undefined') {
				title = "Map "+district.name+" by Survey"
			} else {
				title = "Map "+district.name+" by Survey: "+survey.toUpperCase();
			}
			this.switchTo("map", {title:title});
			mapState = changeMapState(mapState, {
				scale: 'district',
				district: district.name,
				filter: "survey",
				xyz: survey
			})
			this.Map(function(){
				this.mapCenter(district.GLatLng(), {'zoom': 8})
				this.key({clear:true});
				
				
				this.addSelector({text:"District"}, function(selector){
					var main = $("<option />", {value:'all'}).html("Nigeria");
					var big = $("<optgroup />", {'label':"Selector"}).html(main);
					
					var subdistricts = $("<optgroup />", {'label':"LGA"});
					$(districts).each(function(){
                        var opt = $("<option />", {value: this.id}).html(this.name)
	                    subdistricts.append(opt);
	                })
	                selector.append(big);
					selector.append(subdistricts);
					
					selector.val(district.id);
					selector.change(function(){
						if($(this).val()=='all') {
							dashboard.setLocation("#/map");
						} else {
							dashboard.setLocation(urlForMapState({district: $(this).val()}));
						}
					});
				});

				var Showing, _MapEnv = this;
				WithActivityList(function(_list){
					_MapEnv.addSelector({list:getFilters(_list).filters,text:"Filter"}, function(selector){
						var all = $("<option />", {value: 'all'});
						selector.prepend(all);

						if(!mapState.filter){selector.val('all')}else{selector.val(mapState.filter)}

						selector.change(function(){
							var cval = $(this).val();
							if(cval=='all'){cval=null;}

							dashboard.setLocation(urlForMapState({
								district: district,
								filter: cval
							}));
						})
					});
					
					
					Showing = _list.filter('district_id', district.id);

					_MapEnv.addSelector({list:Showing.getVarieties()['survey'],text:"Survey"}, function(selector){
						selector.prepend($("<option />", {'value':'all'}))
						selector.val(survey);
						selector.change(function(){
							var oVal = $(this).val();
							if(oVal=='all') {oVal=null;}
							dashboard.setLocation(urlForMapState({
								district: district,
								filter: 'survey',
								obj: oVal
							}));
						})
					});

					if(survey && survey!=="undefined") {
						Showing = Showing.filter('survey', survey);
					}
					_MapEnv.display(Showing, {
						hideList: _list,
						boundWindow: true
					})
				})
			})
		});
		//end #/map/district/by/survey/*

		dashboard.get("#/map/:district/by/date/?(:obj)?", function(){
			var district = findDistrict(this.params['district']),
				obj = this.params['obj'],
				filterItem = this.params['obj'],
				date = filterItem;

			var title;
			if(date && date!=='undefined') {
				title = "Map "+district.name+" by Date";
			} else {
				title = "Map "+district.name+" by Date: "+date;
			}
			this.switchTo("map", {title:title});
			
			mapState = changeMapState(mapState, {
				scale: 'district',
				district: district.name,
				filter: "date",
				xyz: date
			})
			this.Map(function(){
				this.mapCenter(district.GLatLng(), {'zoom': 8})
				this.key({clear:true});
				
				this.addSelector({list:[],text:"District"}, function(selector){
					var main = $("<option />", {value:'all'}).html("Republic of Nigeria");
					var big = $("<optgroup />", {'label':"State View"}).html(main);
					
					var subdistricts = $("<optgroup />", {'label':"LGA View"});
					$(districts).each(function(){
                        var opt = $("<option />", {value: this.id}).html(this.name)
	                    subdistricts.append(opt);
	                })
	                selector.append(big);
					selector.append(subdistricts);
					
					selector.val(district.id);
					selector.change(function(){
						if($(this).val()=='all') {
							dashboard.setLocation("#/map");
						} else {
							dashboard.setLocation(urlForMapState({district: $(this).val()}));
						}
					});
				});

				var Showing, _MapEnv = this;
				WithActivityList(function(_list){
					_MapEnv.addSelector({list:getFilters(_list).filters,text:"Filter"}, function(selector){

						selector.prepend($("<option />", {value: 'all'}));

						if(!mapState.filter){selector.val('all')}else{selector.val(mapState.filter)}

						selector.change(function(){
							var cval = $(this).val();
							if(cval=='all'){cval=null;}
							dashboard.setLocation(urlForMapState({
								district: district,
								filter: cval
							}));
						})
					})

					Showing = _list.filter('district_id', district.id)
					_MapEnv.addSelector({list:Showing.getVarieties().date,text:"Date"}, function(selector){

						selector.prepend($("<option />", {value: 'all'}));
						selector.val(date);
						selector.change(function(){
							var thisVal = $(this).val();
							if(thisVal=="all") {
								thisVal=false;
							}
							dashboard.setLocation(urlForMapState({
								district: district,
								filter: 'date',
								obj: thisVal
							}));
						})
					});

					if(date && date!=='undefined') {
						Showing = Showing.filter('date', filterItem);
					}
					_MapEnv.display(Showing, {
						hideList: _list,
						boundWindow: true
					})
				})
			})
		});
		//end #/map/district/by/date/*
	})();
	
	var __map;
</script>
<script id="survey-view" type="text/x-jquery-tmpl">
   	<div class="survey-view" title="${title}">
	<table class="fullw">
		<tr>
			<td style="width:48%">
				<div class='im-wrap'>
					<img src="${image_url}" width="100%" />
					<p class='im-caption'>
						${photoContextString}
					</p>
				</div>
			</td>
			<td style="width:48%;vertical-align:top">
				<div class="survey-content" style="overflow:auto;max-height:340px"></div>
			</td>
		</tr>
	</table>
	</div>
</script>
<script type="text/javascript" charset="utf-8">
	var surveyViewTemplate = $('#survey-view').template();
</script>