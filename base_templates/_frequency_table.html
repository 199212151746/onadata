<h2>
	Survey Frequency Tables
</h2>
<div id="freq-table-selector" style="position:relative">
	<div class="map-key-ww"><div class="map-key-w" style="padding:8px">
		<div id="m-key" class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix">
			<table>
				<tbody>
					<tr>
						<td class="selectors">
							<div class="selector-wrap">Rows
								<select id="freq-rows"></select>
							</div>
							<div class="selector-wrap">Columns
								<select id="freq-cols"></select>
							</div>
							<a href="#" style="margin-left:20px" id="get-table">Get Chart</a>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div></div>
</div>
<div id="freq-table" style="padding:65px 15px 10px 15px;"></div>

<script type="text/javascript" charset="utf-8">

	(function($){
		$.fn.thinButton = function(){
			this.button();
			$('span.ui-button-text', this).css({'padding':'1px 5px'});
			return this;
		}
	})(jQuery);
	
	$(function(){
		$('#get-table').thinButton();
		$('#get-table').click(function(evt){
			evt.preventDefault();
		})
	})
	var tableTypes = {{table_types|safe}};
	
	dashboard.get("#/frequency-tables", function(context){
		this.switchTo("frequency-tables");
        this.title("Frequency Tables");
    });
	dashboard.get("#/frequency-tables/:row/:col", function(context){
		this.switchTo("frequency-tables");
        this.title("Frequency Tables");

		var row = this.params['row'],
			col = this.params['col'],
			freqTable = $("#freq-table");
			
		$('#freq-rows').val(row);
		$('#freq-cols').val(col);
		$.get("/submission-counts/"+row+"/"+col, function(html){
			var table = $(html);
			table.addClass('ptable');
			$('tr td', table).each(function(ct, elm){
				var td = $(elm);
				if(td.index()==0) {
					td.addClass('rname');
				} else {
					td.addClass('centered data');
					if(td.text()!=="") {
						td.wrapInner("<div class='dwrap' />")
					}
				}
			});
			$('tr td:first-child', table).removeClass('centered').addClass('rname');
			
			(function sumRows(tab){
				var rows = $("tbody tr", tab);
				$('thead tr th:first-child', tab).after($("<th />", {'class':'sum-header'}).html('&nbsp;'));
				rows.each(function(){
					var sumTd = $("<td />", {'class':'row sum centered'});
					var sum = 0;
					
					$("td.data", this).each(function(){
						if($(this).text()) {
							sum += parseInt($(this).text())
						}
					});
					sumTd.html(sum);
					$(this).find('td:first-child').after(sumTd);
				})
			})(table);
			
			(function sumCols(tab){
				var columnsWithData=[];
				var rows = $("tbody tr", tab);
				rows.find('td.data').each(function(){
					if(!columnsWithData[$(this).index()]) {
						columnsWithData[$(this).index()]=true;
					}
				});
				var sumRow = $("<tr />", {'class':'sum-row'});
				$.each(columnsWithData, function(ct, tf){
					var td = $("<td />");
					if(ct==0) {
						td.addClass("rname");
					}
					if(tf) {
						var sumVals = 0;
						rows.each(function(){
							var txtVal = $($(this).children()[ct]).text(),
								nmVal = parseInt(txtVal);
							if(!isNaN(nmVal)) {
								sumVals += parseInt(nmVal);
							}
						});
						td.text(sumVals);
						td.addClass('centered');
						td.addClass('totals');
					}
					sumRow.append(td)
				});
				$("thead", tab).append(sumRow);
			})(table);
			$('.data').css({'width':75})
			var ftWrap = $("<div />", {'class':'ft-wrap'}).html(table);
			freqTable.html(ftWrap);
		});
	});
	
	(function($, rowSelect, colSelect, submit, tableTypes){
		$.each(tableTypes, function(count, str){
			var _opt = $("<option />", {value: str}).html(capitalizeString(str))
			rowSelect.append(_opt.clone());
			colSelect.append(_opt.clone());
		});
		colSelect.attr('disabled', true)
		rowSelect.change(function(){
			colSelect.attr('disabled', false);
			var selected = this.value;
			
			$(colSelect.find('option')).each(function(){
				if($(this).val()==selected) {
					$(this).attr('disabled', true);
				} else {
					$(this).attr('disabled', false);
				}
			})
		});
		function redirectToSelectedTable() {
			dashboard.setLocation("#/frequency-tables/"+rowSelect.val()+"/"+colSelect.val());
		}
		$('#get-table').click(function(evt){
			redirectToSelectedTable()
			evt.preventDefault();
		})
	})(jQuery, $('#freq-rows'), $('#freq-cols'), $('#freq-submit'), tableTypes)

</script>
