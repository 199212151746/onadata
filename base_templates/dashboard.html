{% extends "base.html" %}
{% block htitle %}Dashboard{% endblock %}
{% block title %}Dashboard{% endblock %}

{% block scripts %}
<script type="text/javascript" charset="utf-8">
//	var baseUrl = "{{dashboard_base_url}}";
</script>
<!-- <script type="text/javascript" src="/site-media/js/nmis.dashboard.sammy.js?idonno"></script> -->
<!-- <script src="/site-media/js/activity-list.js" type="text/javascript" charset="utf-8"></script> -->
<link rel="stylesheet" href="/site-media/css/map-key.css" type="text/css" media="all" title="Sitewide" charset="utf-8" />
{% endblock %}

{% block menu %}
<li class="dashboard"><a href="#/">Data Export</a></li>
<li class="lga-list"><a href="#/lga-list">LGA List</a></li>
<!--
<li class="recent-surveys"><a href="#/activity">Recent Surveys</a></li>
<li class="frequency-tables"><a href="#/frequency-tables">Frequency Tables</a></li>
<li class="map"><a href="#/map">Map</a></li>
-->
{% endblock %}

{% block content %}
<div class="full-content sliding" id="main">
	<div class="iwrap" id="dashboard">
		<div class="iiwrap">
			<!-- Copied from "export_list.html" -->
			<table class="pretty padded">
				<thead>
					<tr>
				    <th>Title</th>
				    <th>Number of Submissions</th>
				    <th>Time of Last Submission</th>
				    <th>Export</th>
				  </tr>
				</thead>
				<tbody>
			{% for xform in xforms %}
				<tr>
				  <td>{{ xform.title }}</td>
				  <td>{{ xform.submission_count }}</td>
				  <td>
				    {% if xform.time_of_last_submission %}
				    {{ xform.time_of_last_submission }}
				    {% endif %}
				  </td>
				  <td>
				    {% if xform.submission_count %}
				    <a href={% url parsed_xforms.views.xls id_string=xform.id_string %}>xls</a>
				    {% endif %}
				  </td>
				</tr>
			{% endfor %}
			</tbody>
			</table>
		</div>
	</div>
	<style type="text/css">
	#pretty-table-wrap {
		z-index:999;
	}
	table#state-lga-list tbody tr.lga-row {
		display: none;
	}
	table#state-lga-list tbody.opened tr.lga-row {
		display: table-row;
	}
	table#state-lga-list span.lga-count {
		font-size: 10px;
		color: #888;
	}
	table#state-lga-list a.discrete-link {
		color: #777;
		font-size: 11px;
	}
	table.popup-context td {
		font-size: 11px;
		color: #444;
	}
	</style>
	<div class="iwrap" id="lga-list">
		<div class="iiwrap">
			<div class='pretty-table-wrap'>
			<table border="0" class="pretty padded" id="state-lga-list">
				<thead>
					<tr>
						<th colspan="3"></th>
						{% for title in zone_table.survey_titles %}
						<th>{{title}}</th>
						{% endfor %}
						<th></th>
					</tr>
					<tr>
						<td colspan="3"></td>
						{% for tot in zone_table.survey_totals_by_title %}
						<td class="centered">{{tot}}</td>
						{% endfor %}
						<td></td>
					</tr>
				</thead>
				{% for state in zone_table.states %}
				<tbody>
					<tr class="state-row">
						<td>{{state.zone_name}}</td>
						<td>{{state.name}}</td>
						<td>
							<span class="lga-count">({{state.lga_count}} LGAs Surveyed)</span>
						</td>
						{% for tot in state.survey_totals_by_title %}
						<td class="centered">{{tot}}</td>
						{% endfor %}
						<td class="state total">
							<span class="total">{{state.total_count}}</span>
						</td>
					</tr>
					{% for lga in state.lga_list %}
					<tr class="lga-row">
						<td colspan="2"><a href="#/map/lga/{{lga.pk}}" class="discrete-link">[View LGA in Map]</a></td>
						<td><a href="#/map/lga/{{lga.pk}}">{{lga.name}}</a></td>
						{% for tot in lga.survey_totals_by_title %}
						<td class="centered">{{tot}}</td>
						{% endfor %}
						<td class="lga total">
							<span class="total">{{lga.total_count}}</span>
						</td>
					</tr>
					{% endfor %}
				</tbody>
				{% endfor %}
			</table>
			</div>
			<div id="map-wrap" style="position:absolute;width:100%;height:100%;top:0;left:0;z-index:0;">
				<div id="map-div" style="height:96%;margin:9px">
				</div>
			</div>
		</div>
	</div>
	<div class="iwrap" id="activity">
		<div class="iiwrap">
			<h2>
				Activities
			</h2>
			<table id="activity-list" class="shade-alternate fullw padded">
				<thead>
					<tr>
						<th>Date</th>
						<th>Surveyor</th>
						<th>Title</th>
						<th>Survey Type
						</th>
					</tr>
				</thead>
			</table>
		</div>
	</div>
	<div class="iwrap" id="frequency-tables">
		<div class="iiwrap">
			<div id="freq-table-selector" style="position:relative">
				<div class="map-key-ww"><div class="map-key-w" style="padding:8px">
					<div id="m-key" class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix">
						<table>
							<tbody>
								<tr>
									<td class="selectors">
										<div class="selector-wrap">Rows
											<select id="freq-rows"></select>
										</div>
										<div class="selector-wrap">Columns
											<select id="freq-cols"></select>
										</div>
										<a href="#" style="margin-left:20px" id="get-table">Get Table</a>
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div></div>
			</div>
			<div id="freq-table" style="padding:65px 15px 10px 15px;"></div>
		</div>
	</div>
	<div class="iwrap" id="map">
		<div class="iiwrap">
			<div class="map-wrap">
			</div>
		</div>
	</div>
</div>

{% endblock %}
{% block js %}
<script type="text/javascript" src="/site-media/js/sammy.extensions.js"></script>

<script type="text/javascript" charset="utf-8">

(function(listTable){
	listTable.find('tr.state-row').click(function(){
		$('tbody.opened', listTable).removeClass('opened');
		$(this).parents('tbody').addClass('opened');
	})
})($('#state-lga-list'))

/*-- clickr is a temporary shortcut to clear localstorage
var clickr = $("<a />", {href:'#','class':'dontChangePage'});
clickr.html('.');
clickr.css({'text-decoration':'none'});
clickr.click(function(){storage.clear('activity');});
$('.account_links').append(clickr);
$('.dontChangePage').live('click', function(evt){evt.preventDefault();})
--*/

	$('.button').button();
	
	function capitalizeString(str) {
	    return str.slice(0,1).toUpperCase() + str.slice(1);
	}
	
	var SetResizer = (function($, resizeSelector, excludeSelector, extraPadding){
		var resizeElem = $(resizeSelector),
			excludeElem = $(excludeSelector);

		function ResizePage(){
			var windowHeight = $(window).height(),
				totalHeight = windowHeight - extraPadding;

			excludeElem.each(function(){totalHeight -= $(this).height();});
			resizeElem.css({'height':totalHeight})
		}
		$(window).resize(ResizePage);

		$(function(){
			resizeElem.css({'overflow':'auto'});
			$(document.body).css({'overflow':'hidden'})
			$(window).trigger('resize')
		});
	});
	(function($){
		$.fn.thinButton = function(){
			this.button();
			$('span.ui-button-text', this).css({'padding':'1px 5px'});
			return this;
		}
	})(jQuery);


	SetResizer(jQuery, ".iiwrap", "#header, #menu", (16+24));

</script>

<script type="text/javascript" charset="utf-8">
/*--
	var District = (function(){
		function District(data) {
			$.extend(this, data);
			var c = this.coords.split(",");
			this.gps = {
				lat: c[0],
				lng: c[1]
			}
		}
		District.prototype = new Mappable();
		District.prototype.GLatLng = function(){
			var ll = this.coords.split(",");
			return new google.maps.LatLng(ll[0],ll[1]);
		}
		District.prototype.ensureKmlLoaded = function(map){
			if(!this.kmlLayer) {
				this.kmlLayer = new google.maps.KmlLayer(this.kml+"?b", {
					map: map,
					preserveViewport: true
				});
			}
		}
		return District;
	})//(jQuery);
	
	var states = {{states_lgas|safe}};
	
	$(function addStateLgaLinks(){
		var stateList = $("<ul />");
		$.each(states, function(i, sd){
			var stateLi = $("<li />").text(sd.name);
			var lgaList = $("<ul />");
			$.each(sd.lgas, function(ii, lga){
				var lgaLink = $("<a />", {'href':'#/map/'+lga.slug}).text(lga.name);
				lgaList.append($("<li />", {'id': 'lga-link-'+lga.slug}).html(lgaLink));
			})
			stateList.append(stateLi)
				.append(lgaList);
		});
		$('#lga-list').find('.iiwrap').append(stateList);
	});
	--*/

//	var districts = $({{districts|safe}}).map(function(){return new District(this)})
//	function findDistrict(did) {var result; $(districts).each(function(){if(did==this.id){result=this; return false;}}); return result;}
</script>

<script type="text/javascript" charset="utf-8">
(function(){
    Sammy.GoogleMaps = function(){
        var loadStarted = false,
            loadFinished = false,
            gmap = false,
            map,
            mapKey = false,
            gmapElem = false;
        this.setMapElem = function(elem){
            gmapElem = $(elem);
        }
        function mapObj() {
            this.sammyMap=true;
        }
        $.extend(mapObj.prototype, {
            mapCenter: function(center, opts){
                var zoom = opts.zoom;
                if(opts.bounds) {
                    var ne = new google.maps.LatLng(opts.bounds.lat.min, opts.bounds.lng.min);
                    var sw = new google.maps.LatLng(opts.bounds.lat.max, opts.bounds.lng.max);
                    var bounds = new google.maps.LatLngBounds(sw, ne);
                }
                this.map.setCenter(center);
                if(zoom) {
                    this.map.setZoom(zoom)
                }
            },
            ensureDistrictKmls: function(){
                var _map = this.map;
                $(districts).each(function(){
                    this.ensureKmlLoaded(_map);
                })
            },
            display: function(list, opts){
                if(!opts){var opts={}}
                if(opts.hideList) {
                    $(opts.hideList).each(function(){
                        if(list.indexOf(this)==-1) {
                            this.hideMapPoint();
                        } else {
                            this.showMapPoint();
                        }
                    })
                } else {
                    $(arr).each(function(){
                        this.showMapPoint();
                    });
                }
                if(opts.boundWindow) {
                    var curWindow = list.latLngWindow();
					if(curWindow) {
						this.setMapCenter(curWindow.lat, curWindow.lng, curWindow)
					}
                }
            },
            key: function(opts){
                if(!this.mapKey) {
                    this.mapKey = MapKey.create()
                    gmapElem.parent().append(this.mapKey)
                }
                if(opts && opts.clear) {
                    MapKey.selectors().empty();
                }
				return this.mapKey;
            },
            addSelector: function(opts, fn){
                var choices = opts.list || [],
                    text = opts.text,
                    selector = $("<select />");

                $(choices).each(function(){
                    if(this.name) {
                        var opt = $("<option />", {value: this.id}).html(capitalizeString(this.name))
                    } else {
                        var opt = $("<option />", {value: String(this)}).html(capitalizeString(String(this)));
                    }
                    selector.append(opt);
                });

                var selectorDiv = $("<div />", {'class':'selector-wrap'}).html(text);
                selectorDiv.append(selector);
                MapKey.selectors().append(selectorDiv);
                fn.call(this, selector);
            },
            divider: function(){
                MapKey.addDivider();
            },
            debug: function(mapState){
                str = "";
                str += "scale: " + mapState.scale
                if(mapState.district) {
                    str += " &mdash ";
                    str += "district: " + mapState.district
                }
                if(mapState.filter) {
                    str += " &mdash ";
                    str += "filter: " + mapState.filter
                }
                if(mapState.xyz) {
                    str += " &mdash ";
                    str += "x: "+ mapState.xyz
                }
                if(mapState.points) {
                    str += " &mdash ";
                    str += "point count: "+ mapState.points.length
                }
            },
            setMapCenter: function(lat, lng, opts){
                var opts = opts || {};
                var zoom = opts.zoom;
                this.map.setCenter(new google.maps.LatLng(lat, lng))
                if(opts.range) {
                    var ne = new google.maps.LatLng(opts.range.lat.min, opts.range.lng.max);
                    var sw = new google.maps.LatLng(opts.range.lat.max, opts.range.lng.min);
                    var bounds = new google.maps.LatLngBounds(sw, ne);
                    this.map.fitBounds(bounds);
                }
            },
            defaultCenter: function(){
                this.map.setZoom(defaultMapCenter.zoom);
                this.map.setCenter(new google.maps.LatLng(defaultMapCenter.lat, defaultMapCenter.lng))
            },
            getMapElem: function(){return gmapElem}
        });
        map = new mapObj();

        this.helper('SetMapElem', function(elem){gmapElem = $(elem)});
        var mapLoadCallbacks = [];
        this.helper('addMapLoadCallback', function(cb){mapLoadCallbacks.push(cb);})
        this.helper('Map', function(cb){
            mapLoadCallbacks.push(cb);
            if(!loadFinished) {
                var sammyObj = this;
                gmapElem.bind('gmapLoaded', function(){
                    //make the map and call the callback with the first argument as the map object
                    gmap = new google.maps.Map(gmapElem.get(0), {zoom:6,center:new google.maps.LatLng(9.243092645104804, 7.9156494140625), mapTypeId:'terrain', mapTypeControl: false});
                    _map = gmap;
                    map.map = gmap;
//                    cb.call(map);
                    $(mapLoadCallbacks).each(function(){
                        this.call(map);
                    })
                });
            } else {
                if(!gmap) {
                    gmap = new google.maps.Map(gmapElem.get(0), {zoom:6,center:new google.maps.LatLng(9.243092645104804, 7.9156494140625), mapTypeId:'terrain', mapTypeControl: false });
                    map.map = gmap;
                    _map = gmap;
                }
                // cb.call(map);
                $(mapLoadCallbacks).each(function(){
                    this.call(map);
                })
            }
            if(!loadStarted) {
                $.getScript('http://maps.google.com/maps/api/js?sensor=false&callback=SammyMapLoaded');
                loadStarted = true;
            }
        });
        SammyMapLoaded = function(){
            loadFinished = true;
            if(gmapElem) {
                $(gmapElem).trigger('gmapLoaded');
            }
        }
    }
})();

var MapKey = (function(){
	var mapKeyElem,
	    mapKeySelectors,
	    mapTypeSelectors,
		mapPar;
	return {
		create: function(){
		    var odiv = $.json2dom([
		            "div", {'class':'map-key-ww'}, [
		                "div", {'class': 'map-key-w'}, [
		                    "div", {'class': 'ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix', 'id': 'm-key'},
		                        ["table", {}, ["tbody", {}]]
		                ]
		            ]
		        ]);

		    this.tr = $("<tr />");
		    this.tr.append($("<td />", {'class':'empty-spacer'}).html("<div />"));

		    mapKeySelectors=$('<td />', {'class':'selectors'});
	        this.tr.append(mapKeySelectors);

	        this.appendMapTypeSelector();

		    $("tbody", odiv).append(this.tr);
			return odiv;
		},
		prependButton: function(text, url){
			this.tr.prepend($("<td />").html($("<a />", {'href':url}).text(text).thinButton()));
		},
		appendMapTypeSelector: function(){
		    mapTypeSelectors = $("<td />", {'id':'map-type-choices'})
		    var terrainButton = $("<a href='#'>Terrain</a>");
            terrainButton.click(function(evt){
                _map.setMapTypeId(google.maps.MapTypeId.TERRAIN);
                evt.preventDefault();
            });
            var satelliteButton = $("<a href='#'>Satellite</a>");
            satelliteButton.click(function(evt){
                _map.setMapTypeId("satellite")
                evt.preventDefault();
            });
            var mapButton = $("<a href='#'>Map</a>");
            mapButton.click(function(evt){
                _map.setMapTypeId('roadmap')
                evt.preventDefault();
            });
            var tDiv = $("<div />").css({'float':'right'});
            tDiv.append(terrainButton).append(satelliteButton).append(mapButton);
            mapTypeSelectors.append(tDiv);
            $('a', mapTypeSelectors).button().find('span.ui-button-text').css({'padding':'1px 5px'});
            this.tr.append(mapTypeSelectors);
		},
		selectors: function(){
		    return mapKeySelectors;
		},
		empty: function(){
		    this.tr.empty();
		},
		insert: function(cb){
		    var td = $("<td />").html(cb);
		    this.tr.append(td);
		},
		addDivider: function(){
			this.tr.append($("<td />").html($("<div />", {'class':'table-spacer'})));
		},
		addDistrictDropdown: function(){
			this.districtSelector = $("<select />");
			var nigeria = $("<option />", {value:'all'}).html("Republic of Nigeria");
			var allOpt = $("<optgroup />", {label:'Full view'}).html(nigeria)

			var districtView = $("<optgroup />", {label: 'District view'})
			this.districtSelector.append(allOpt);
			$(districts).each(function(){
				var opt = $("<option />", {value: this.id}).html(this.name);
				districtView.append(opt);
			});
			this.districtSelector.append(districtView);
			this.tr.append($("<td />").html(this.districtSelector));
			return this.districtSelector;
		},
		addChoiceDropdown: function(){
			this.addDivider();
			this.choiceSelector = $("<select />");
			this.choiceSelector.append($("<option>Date</option>"));
			this.choiceSelector.append($("<option>Surveyor</option>"));
			this.choiceSelector.append($("<option>Survey</option>"));
			this.iDiv.find('tr').append($('<td />').html(this.choiceSelector))
			return this.choiceSelector;
		},
		addSpecificityDropdown: function(choices){
			this.addDivider();
			var opt, selector = $("<select />");
			$(choices).each(function(){
				opt = $("<option />").html(this);
				selector.append(opt);
			});
			this.tr.append($("<td />").html(selector))
		},
		showSelection: function(pType) {
//				console.log("make selection for ", pType);
		}
	}
})();

	var dashboard = (function($){
/*--		var menu = $('#menu .fwidth').empty();
        menu.append($('<li />', {'class':'dashboard'}).html($("<a />", {href:"#/"}).html("Data Export"))); //why is this not loading in the page?
        menu.append($('<li />', {'class':'lga-list'}).html($("<a />", {href:"#/lga-list"}).html("LGA List"))); //why is this not loading in the page?
        menu.append($('<li />', {'class':'activity'}).html($("<a />", {href:"#/activity"}).html("Recent Surveys")))
        menu.append($('<li />', {'class':'frequency-tables'}).html($("<a />", {href:"#/frequency-tables"}).html("Frequency Tables")))
        menu.append($('<li />', {'class':'map'}).html($("<a />", {href:"#/map"}).html("Map")));
--*/

	    var dashboard = $.sammy("#main", function(){
	        this.use(Sammy.Storage);
			
	        this.use(Sammy.SwitchTo);
	        this.use(Sammy.GoogleMaps);
			this.setMapElem("#map-div");
	

	        this.use(Sammy.Title);
	        this.setTitle(function(title){
	            return ["Baseline Data Collection: ", title].join("");
	        });

	        this.use(Sammy.Template);
	    });
	    $(function(){
	        dashboard.run("#/");
	        dashboard.switchToDuration(200);
	    });
	    return dashboard;
	})(jQuery);
	dashboard.activateSwitchTo(".full-content.sliding");
</script>

<script type="text/javascript" charset="utf-8">
	/*-- landing page
	--*/
	dashboard.get("#/", function(context){
        var dashbElem = this.switchTo("dashboard", {title: "Data"});
    });

	/*-- LGA/State List
	--*/
	dashboard.get("#/lga-list", function(){
		var pageElem = this.switchTo("lga-list", {title: "LGA List"});
		$('.pretty-table-wrap', pageElem).fadeIn().css({'z-index':99});
		$("#map-wrap", pageElem).fadeOut();
	});
	
	dashboard.get("#/map/lga/:lga_id", function(){
		var lgaId = this.params.lga_id;
		var pageElem = this.switchTo("lga-list", {title: "LGA Map"});
		$('.pretty-table-wrap', pageElem).fadeOut();
		$("#map-wrap", pageElem).fadeIn();
		var that = this;
		
		var oneTime = 0;
		
		$.retrieveJSON("/xforms/map_data_points/"+lgaId+"/", function(data){
			if(!oneTime++) {
				var list = new ActivityList(data);
				var llWindow = list.latLngWindow();
				if(llWindow) {
					var neBounds = [llWindow.range.lat.max, llWindow.range.lng.max];
					var swBounds = [llWindow.range.lat.min, llWindow.range.lng.min];
					that.Map(function(){
						__map = this.map;
						var center = new google.maps.LatLng(llWindow.range.lat.avg,
											llWindow.range.lng.avg);
						var ne = new google.maps.LatLng(neBounds[0], neBounds[1]);
						var sw = new google.maps.LatLng(swBounds[0], swBounds[1]);
	                    var bounds = new google.maps.LatLngBounds(sw, ne);
						this.map.fitBounds(bounds);
						var map = this.map;
						var nav = this.key({clear:true});
						MapKey.empty();
						MapKey.appendMapTypeSelector();
						MapKey.prependButton("Back to the List of LGAs", "#/lga-list");
						list.each(function(){
							if(!this.gps) {
								return;
							}
							if(!this.pt) {
								var position = new google.maps.LatLng(this.gps.lat, this.gps.lng);
								this.pt = new google.maps.Marker({
									title: this.title,
									position: position,
									icon: this.icon()
								});
								this.pt.activityPoint = this;
								this.pt.setMap(map);
								var thatPt = this;
								google.maps.event.addListener(this.pt, 'click', function(){
									var oneTime = 0;
									var jsonUrl = "/xforms/survey/"+this.activityPoint.instanceId+"/";
									$.retrieveJSON(jsonUrl, function(data){
										if(!oneTime++) {
											InstancePopup(thatPt, data);
										}
									})
				        		});
							}
						})
					})
				}
			}
		});
	});
	
	var MapPopup = (function(){
		var showing = false;  //,		  wrapElem;
		return (function show(elem){
			if(showing) {
				$(showing).dialog('close');
				$(showing).remove();
			}
			$(elem).dialog({
				resizable: false,
				width: 600
			});
			showing = elem;
		});
	})();
	
	function InstancePopup(activityPoint, data) {
		var popupElem = $("<div />", {'style':'max-height:500px;overflow:auto'});
		if(activityPoint.imageUrl) {
			popupElem.append($("<div />", {'class': 'instance-image'}).html());
		}
		var topContext = $("<tbody />");
//		topContext.append($("<tr />", {'rowspan':4}).html())
		var link = $("<a />", {'href': activityPoint.imageUrl, target: '_blank', 'style':'float:left;display:block;width:80px;height:80px;margin:2px 8px 8px 0'}).html($("<img />", {'src': activityPoint.imageUrl}));
		var tcWrap = $("<div />", {'class':'clearfix'}).append(link).append($("<table />", {'class':'popup-context'}).html(topContext));
		var ddList = $("<dl />", {'style':'clear:both'});
		$.each(data, function(i, qaPair){
			if(qaPair[0]=="imei") {
				var tr = $("<tr />");
				tr.append($("<td />").text("Device ID"))
					.append($("<td />").text(qaPair[1]))
				topContext.append(tr)
			} else if(qaPair[0]=="start_time") {
				var tr = $("<tr />");
				tr.append($("<td />").text("Start Time"))
					.append($("<td />").text(qaPair[1]))
				topContext.append(tr)
			} else if(qaPair[0]=="end_time") {
				var tr = $("<tr />");
				tr.append($("<td />").text("End Time"))
					.append($("<td />").text(qaPair[1]))
				topContext.append(tr)
			} else {
				ddList.append($("<dt />").text(qaPair[0]))
					.append($("<dd />").text(qaPair[1]));
			}
		});
		popupElem.append(tcWrap);
		popupElem.append(ddList);
		MapPopup($("<div />", {title: activityPoint.title}).html(popupElem))
	}
	
	var ActivityList, ActivityPoint;
	(function($){
		function _ActivityList(arr){
			if(arr){
				this.addPoints(arr)
			}
		}
		_ActivityList.prototype = new Array();
		$.extend(_ActivityList.prototype, {
			find: function(id){
				var i = 0, l=this.length;
				for(;i<l;i++) {
					if(id==this[i].id) {
						return this[i];
					}
				}
				return false;
			},
			each: function(cb){
				$(this).each(cb);
			},
			filter: function(k, v){
				var subList = new _ActivityList([]);
				if($.type(v)=='string') {
					v=v.toLowerCase();
				}
				$(this).each(function(){
					if($.type(this[k])==='string') {
						if(this[k].toLowerCase()===v) {
							subList.addPoint(this);
						}
					} else {
						if(this[k]===v) {
							subList.addPoint(this)
						}
					}
				});
				return subList;
			},
			addPoint: function(point){
				this.push(new _ActivityPoint(point))
			},
			addPoints: function(points){
				var _Sl = this;
				$(points).each(function(){_Sl.addPoint(this)});
			},
			latLngWindow: function(){
				var lats = [], lngs = [];
				$.each(this, function(){
					if(this.gps && this.gps.lat) {
						lats.push(this.gps.lat);
						lngs.push(this.gps.lng);
					}
				});
				if(lats.length == 0 || lngs.length==0) {
					return null;
				}
				var llRange = {
					lat: {
						min: Math.min.apply(this, lats),
						max: Math.max.apply(this, lats)
					},
					lng: {
						min: Math.min.apply(this, lngs),
						max: Math.max.apply(this, lngs)
					}
				}
				llRange.lat.avg = (llRange.lat.min + llRange.lat.max)/2
				llRange.lng.avg = (llRange.lng.min + llRange.lng.max)/2
				return {
					lat: llRange.lat.avg,
					lng: llRange.lng.avg,
					range: llRange
				}
			},
			getVarieties: function(){
				var survey_types = [], dates = [], surveyors = [];
				$(this).each(function(){
					if(survey_types.indexOf(this.survey_type)==-1) { survey_types.push(this.survey_type); }
					if(dates.indexOf(this.date)==-1) { dates.push(this.date); }
					if(surveyors.indexOf(this.surveyor)==-1) { surveyors.push(this.surveyor); }
				});
				return {
					surveyor: surveyors,
					date: dates,
					survey: survey_types
				}
			}
		})

	    var months = "Jan Feb Mar Apr May June July Aug Sept Oct Nov Dec".split(" ");
		function _ActivityPoint(o){
			if(o instanceof _ActivityPoint) {return o}
			this._contents = o;
			var ll = o['location/gps'].split(" ");
			this.gps = {lat: ll[0], lng: ll[1]};
			this.surveyType = o._name;
			this.surveyor = o._surveyor_name;
			this.instanceId = o._id;
			this.time = o.start_time;
			this.title = this.surveyType;
			this.imageUrl = o._attachments[0];
			if(this.imageUrl) {this.imageUrl = '/site-media/'+this.imageUrl;}
/*--			this.id = o._id;
			this.survey_type = o._instance_doc_name;
			this.surveyor = o._surveyor_name;
			if(this.surveyor===null) {
			    this.surveyor = o.device_id;
			}

	        this.image_url = "/survey/"+this.id+"/";

	        if(o.geopoint) {
	            this.gps = {
	                'lat': o.geopoint.latitude,
	                'lng': o.geopoint.longitude,
	                'alt': o.geopoint.altitude,
	                'acc': o.geopoint.accuracy
	            }
	        }

	        this.district_id = o._district_id;
	        if(o.start && o.start['$date']) {
	            this.dateObj = new Date(o.start['$date']);
	        }
	        this.date = ""+this.dateObj.getDay()+"-"+months[this.dateObj.getMonth()]+"-"+(1900+this.dateObj.getYear());
	        this.time = ""+this.dateObj.getHours()+":"+ (this.dateObj.getMinutes() < 10 ? "0" : "") + this.dateObj.getMinutes();
	        this.datetime = this.time + "-" + this.date

			this.survey = this.survey_type; //can't pick a consistent name here... --*/
		}
		var flagColors = "blue green orange pink purple red yellow".split(" ");
		var stColors = {
			water: "blue",
			health: "red",
			agriculture: "orange",
			lga: "purple",
			education: "green"
		};
		
		_ActivityPoint.prototype.icon = function(){
			var color = stColors[this.surveyType.toLowerCase()]
			var icon = new google.maps.MarkerImage("/site-media/images/geosilk/flag_"+color+".png", new google.maps.Size(16, 16),
		        new google.maps.Point(0,0), new google.maps.Point(9, 15));
		    
			return icon;
		}
		_ActivityPoint.prototype.shadow = function(){
			var icon = new google.maps.MarkerImage("/site-media/images/gmap-smaller-dots/"+color+".png", new google.maps.Size(13, 13),
		        new google.maps.Point(0,0), new google.maps.Point(6, 6));
		    
			return icon;
		}
		
//		_ActivityPoint.prototype = new Mappable();
	    _ActivityPoint.prototype.mapPointListener = function(){
			var dest = $('<div />', {'class':'survey-content'});
			$.get(baseUrl+'survey/'+this.id+'/', function(data){
				dest.append(data);
			});
			MapPopup(dest);
	    }
		_ActivityPoint.prototype.district=function(){
			var result, district_id = this.district_id;
			if(this.district_id) {
				$(districts).each(function(){ if(this.id==district_id) {result = this} })
			}
			return result;
		}
		window.ActivityList = _ActivityList;
	})(jQuery);
	
	
</script>

{% endblock %}
{% block noop %}
<!-- the stuff below this line will be worked into the code above. -->
<script type="text/javascript" charset="utf-8">
	function Mappable(){}
	Mappable.prototype.showMapPoint = function() {
	    if(this.gps && this.gps.lat) {
	    	if(!this.mapPoint) {
	    		var ll = new google.maps.LatLng(this.gps.lat, this.gps.lng)
	    		this.mapPoint = new google.maps.Marker({
	    			title: this.title,
	    			position: ll,
	    			map: _map,
	    			icon: this.icon()
	    		});
	    		if(this.mapPointListener) {
	    		    var _pt = this;
	        		google.maps.event.addListener(this.mapPoint, 'click', function(){
	        		    _pt.mapPointListener();
	        		});
	    		}
	    	}
	    	this.mapPoint.setVisible(true)
	    }
	}
	Mappable.prototype.flagColor = 'green';
	var flagColors = "blue green orange pink purple red yellow".split(" ");
	Mappable.prototype.shadow = function(){};
	Mappable.prototype.icon = function(){
	    var color = "grey";
	    if('undefined'===typeof this.survey_type_object){
	        this.survey_type_object = surveyTypes[this.survey_type];
	    }
	    color = this.survey_type_object.color.toLowerCase();
	    var icon = new google.maps.MarkerImage("/site-media/images/gmap-smaller-dots/"+color+".png", new google.maps.Size(13, 13),
	        new google.maps.Point(0,0), new google.maps.Point(6, 6));
	    return icon;
	//	return "http://thydzik.com/thydzikGoogleMap/markerlink.php?text="+this.iconText+"&color="+this.iconColor;
	}
	Mappable.prototype.setFlagColor = function(color) {
	    if(this.flagColor==color) {
	        return;
	    }
	    if(flagColors.indexOf(color)!==-1) {
	        this.flagColor = color;
	    } else {
	        this.flagColor = "yellow"
	    }
	    this.updateIcon();
	}
	Mappable.prototype.updateIcon = function(){
	    if(this.mapPoint) {
	        this.mapPoint.setIcon(this.icon())
	    }
	}
	Mappable.prototype.iconText = "1";
	Mappable.prototype.iconColor = "ff0000";
	Mappable.prototype.hideMapPoint = function(){
	    if(this.mapPoint) {
	    	this.mapPoint.setVisible(false)
	    }
	}

	var MapKey = (function(){
		var mapKeyElem,
		    mapKeySelectors,
		    mapTypeSelectors,
			mapPar;
		return {
			create: function(){
			    var odiv = $.json2dom([
			            "div", {'class':'map-key-ww'}, [
			                "div", {'class': 'map-key-w'}, [
			                    "div", {'class': 'ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix', 'id': 'm-key'},
			                        ["table", {}, ["tbody", {}]]
			                ]
			            ]
			        ]);

			    this.tr = $("<tr />");
			    this.tr.append($("<td />", {'class':'empty-spacer'}).html("<div />"));

			    mapKeySelectors=$('<td />', {'class':'selectors'});
		        this.tr.append(mapKeySelectors);

		        this.appendMapTypeSelector();

			    $("tbody", odiv).append(this.tr);
				return odiv;
			},
			appendMapTypeSelector: function(){
			    mapTypeSelectors = $("<td />", {'id':'map-type-choices'})
			    var terrainButton = $("<a href='#'>Terrain</a>");
	            terrainButton.click(function(evt){
	                _map.setMapTypeId(google.maps.MapTypeId.TERRAIN);
	                evt.preventDefault();
	            });
	            var satelliteButton = $("<a href='#'>Satellite</a>");
	            satelliteButton.click(function(evt){
	                _map.setMapTypeId("satellite")
	                evt.preventDefault();
	            });
	            var mapButton = $("<a href='#'>Map</a>");
	            mapButton.click(function(evt){
	                _map.setMapTypeId('roadmap')
	                evt.preventDefault();
	            });
	            var tDiv = $("<div />").css({'float':'right'});
	            tDiv.append(terrainButton).append(satelliteButton).append(mapButton);
	            mapTypeSelectors.append(tDiv);
	            $('a', mapTypeSelectors).button().find('span.ui-button-text').css({'padding':'1px 5px'});
	            this.tr.append(mapTypeSelectors);
			},
			selectors: function(){
			    return mapKeySelectors;
			},
			empty: function(){
			    this.tr.empty();
			},
			insert: function(cb){
			    var td = $("<td />").html(cb);
			    this.tr.append(td);
			},
			addDivider: function(){
				this.tr.append($("<td />").html($("<div />", {'class':'table-spacer'})));
			},
			addDistrictDropdown: function(){
				this.districtSelector = $("<select />");
				var nigeria = $("<option />", {value:'all'}).html("Republic of Nigeria");
				var allOpt = $("<optgroup />", {label:'Full view'}).html(nigeria)

				var districtView = $("<optgroup />", {label: 'District view'})
				this.districtSelector.append(allOpt);
				$(districts).each(function(){
					var opt = $("<option />", {value: this.id}).html(this.name);
					districtView.append(opt);
				});
				this.districtSelector.append(districtView);
				this.tr.append($("<td />").html(this.districtSelector));
				return this.districtSelector;
			},
			addChoiceDropdown: function(){
				this.addDivider();
				this.choiceSelector = $("<select />");
				this.choiceSelector.append($("<option>Date</option>"));
				this.choiceSelector.append($("<option>Surveyor</option>"));
				this.choiceSelector.append($("<option>Survey</option>"));
				this.iDiv.find('tr').append($('<td />').html(this.choiceSelector))
				return this.choiceSelector;
			},
			addSpecificityDropdown: function(choices){
				this.addDivider();
				var opt, selector = $("<select />");
				$(choices).each(function(){
					opt = $("<option />").html(this);
					selector.append(opt);
				});
				this.tr.append($("<td />").html(selector))
			},
			showSelection: function(pType) {
	//				console.log("make selection for ", pType);
			}
		}
	})();

	var SammyMapLoaded,
	    _map;
	

	
</script>


<script id="activityRow" type="text/x-jquery-tmpl">
    <tr>
		<td class='date'>
			<span class="dt">${datetime}</span>
		</td>
		<td class='surveyor'>${surveyor}</td>
		<td class='title'>${title}</td>
		<td class='survey_type ${survey_type}'>${survey_type}</td>
	</tr>
</script>

<script type="text/javascript" charset="utf-8">
	/*- Populate the "Activity List" section
	- 
	-*/
	$(function(){
		WithActivityList(function(list){
			var templateList = [],
				templ = $('#activityRow').template();

			//for some reason, the activity-list cannot be run through the $.tmpl()
			$(list.sort(function(a, b){return a.dateObj < b.dateObj})).each(function(){templateList.push(this)});
			$.tmpl(templ, templateList).appendTo($("#activity-list"))
			delete(templateList)
		});
	});
	dashboard.get("#/activity", function(context){
		this.switchTo("activity");
        this.title("Activity");
    });

</script>

<script type="text/javascript" charset="utf-8">

		$(function(){
			$('#get-table').thinButton();
			$('#get-table').click(function(evt){
				evt.preventDefault();
			})
		});
		var tableTypes = {{table_types|safe}};

		$(function(){
			(function($, rowSelect, colSelect, submit, tableTypes){
				$.each(tableTypes, function(count, str){
					var _opt = $("<option />", {value: str}).html(capitalizeString(str))
					rowSelect.append(_opt.clone());
					colSelect.append(_opt.clone());
				});
				colSelect.attr('disabled', true)
				rowSelect.change(function(){
					colSelect.attr('disabled', false);
					var selected = this.value;

					$(colSelect.find('option')).each(function(){
						if($(this).val()==selected) {
							$(this).attr('disabled', true);
						} else {
							$(this).attr('disabled', false);
						}
					})
				});
				function redirectToSelectedTable() {
					dashboard.setLocation("#/frequency-tables/"+rowSelect.val()+"/"+colSelect.val());
				}
				$('#get-table').click(function(evt){
					redirectToSelectedTable()
					evt.preventDefault();
				})
			})(jQuery, $('#freq-rows'), $('#freq-cols'), $('#freq-submit'), tableTypes)
		});
		
</script>


<script type="text/javascript" charset="utf-8">
	var surveyTypes = {};
//	$.each({{survey_types|safe}}, function(k, v){
//		surveyTypes[v.slug] = v;
//	});
	var defaultMapCenter = {
		lat: 9.243092645104804,
		lng: 7.9156494140625,
		zoom: 6
	};

	
	var _map;
	var filters = "survey surveyor date".split(" ")
	
	var _filters, _values;
	function getFilters(_list) {
		if(!_filters) {
			_values = _list.getVarieties();
			_filters = [];
			$.each(_values, function(k, v) {
				_filters.push(k);
			})
		}
		return {
			'filters': _filters,
			'values': _values
		}
	}
	
	var mapByOpts = {
		lga: "LGA",
		surveyor: "Surveyor",
		survey_type: "Survey Type"
	};
	
	function urlForMapState(hsh) {
		var str = "#/map";
		if(hsh.district) {
			if(hsh.district.id) {
				str+= "/"+hsh.district.id;
			} else {
				str+= "/"+hsh.district;
			}
		} else {
			return str;
		}
		if(hsh.filter) {
			str += "/by/"+hsh.filter
		} else {
			return str;
		}
		if(hsh.obj) {
			str += "/"+hsh.obj;
		}
		return str;
	}
	
	$(function(){
		var mapState = {};
		
		function changeMapState(ms, opts) {
			return $.extend(ms, opts);
		}
		
		dashboard.setMapElem("#map > div");
		
		dashboard.get("#/map", function(context){			
			this.switchTo("map", {title: 'Map'});
			mapState = changeMapState(mapState, {
				scale: 'country',
				district: null,
				filter: null
			})
			this.addMapLoadCallback(function(){
				this.ensureDistrictKmls();
			})
			this.Map(function(){
				__map = this.map;
				this.defaultCenter();

				this.key({clear:true});
				this.addSelector({list:[],text:"Select District"}, function(selector){
					var main = $("<option />", {value:'all'}).html("Nigeria");
					var big = $("<optgroup />", {'label':"Selector"}).html(main);
					
					var subdistricts = $("<optgroup />", {'label':"LGA"});
					$(districts).each(function(){
                        var opt = $("<option />", {value: this.id}).html(this.name)
	                    subdistricts.append(opt);
	                })
	                selector.append(big);
					selector.append(subdistricts);
					
					selector.val('all');
					selector.change(function(){
						if($(this).val()=='all') {
							dashboard.setLocation("#/map");
						} else {
							dashboard.setLocation(urlForMapState({district: $(this).val()}));
						}
					});
				});
				var _MapEnv = this;
				WithActivityList(function(list){
					_MapEnv.display([], {hideList: list})
				})
			})
	    });
		//end #/map
		
		
		dashboard.get("#/map/:district", function(){
			var district = findDistrict(this.params['district']);
			
			this.switchTo("map", {title:"Map "+district.name});
			
			mapState = changeMapState(mapState, {
				scale: 'district',
				district: district.name,
				filter: null
			});

			this.Map(function(){
				this.mapCenter(district.GLatLng(), {'zoom': 8})
				this.key({clear:true});
				
				this.addSelector({text:"District"}, function(selector){
					var main = $("<option />", {value:'all'}).html("Nigeria");
					var big = $("<optgroup />", {'label':"Selector"}).html(main);

					var subdistricts = $("<optgroup />", {'label':"LGA"});
					$(districts).each(function(){
                        var opt = $("<option />", {value: this.id}).html(this.name)
	                    subdistricts.append(opt);
	                })
	                selector.append(big);
					selector.append(subdistricts);
					
					selector.val(district.id);
					
					selector.change(function(){
						if($(this).val()=='all') {
							dashboard.setLocation("#/map");
						} else {
							dashboard.setLocation(urlForMapState({district: $(this).val()}));
						}
					});
				});
				
				var Showing, _MapEnv = this;
				WithActivityList(function(list){
					Showing = list.filter('district_id', district.id);

					_MapEnv.addSelector({list:getFilters(list).filters,text:"Filter"}, function(selector){
						selector.prepend("<option />", {'value':'all'});
						selector.val('all');
						selector.change(function(){
							var cval = $(this).val();
							if(cval=='all'){cval=null;}

							dashboard.setLocation(urlForMapState({
								district: district,
								filter: cval
							}));
						})
					});
					
					_MapEnv.display(Showing, {
						hideList: list,
						boundWindow: true
					})
				})
			})
		})
		//end #/map/district
		
		dashboard.get("#/map/:district/by/surveyor/?(:obj)?", function(){
			var district = findDistrict(this.params['district']),
				filterItem = this.params.obj,
				surveyor = this.params.obj;

			var title;
			if(surveyor && surveyor !=='undefined') {
				title = "Map "+district.name+" by Surveyor";
			} else {
				title = "Map "+district.name+" by Surveyor: "+surveyor;
			}
			this.switchTo("map", {title: title});
			mapState = changeMapState(mapState, {
				scale: 'district',
				district: district.name,
				filter: 'surveyor',
				xyz: surveyor
			});
			this.Map(function(){
				this.mapCenter(district.GLatLng(), {'zoom': 8})
				this.key({clear:true});
				
				this.addSelector({list:[],text:"District"}, function(selector){
					var main = $("<option />", {value:'all'}).html("Nigeria");
					var big = $("<optgroup />", {'label':"Selector"}).html(main);
					
					var subdistricts = $("<optgroup />", {'label':"LGA"});
					$(districts).each(function(){
                        var opt = $("<option />", {value: this.id}).html(this.name)
	                    subdistricts.append(opt);
	                })
	                selector.append(big);
					selector.append(subdistricts);
					
					selector.val(district.id);
					selector.change(function(){
						if($(this).val()=='all') {
							dashboard.setLocation("#/map");
						} else {
							dashboard.setLocation(urlForMapState({district: $(this).val()}));
						}
					});
				});

				var Showing, _MapEnv = this;
				WithActivityList(function(list){
					_MapEnv.addSelector({list:getFilters(list).filters, text:"Filter"}, function(selector){
						var all = $("<option />", {value: 'all'});
						selector.prepend(all);
						if(!mapState.filter){ selector.val('all'); } else { selector.val(mapState.filter); }
						
						selector.change(function(){
							var cval = $(this).val();
							if(cval=='all'){cval=null;}
							dashboard.setLocation(urlForMapState({
								district: district,
								filter: cval
							}));
						})
					})
					
					Showing = list.filter('district_id', district.id),
						surveyorList = Showing.getVarieties().surveyor;
					
					_MapEnv.addSelector({text:"Surveyor"}, function(selector){
						var opts = {
							all: $("<option />", {value: 'all'}),
							filterGroup: $("<optgroup />", {label: 'Filter'})
						};
						$(surveyorList).each(function(){
							opts.filterGroup.append($("<option />").html(String(this)));
						});
						selector.append(opts.all);
						selector.append(opts.filterGroup);
						selector.val(filterItem || 'all');
						selector.change(function(){
							var sval = $(this).val();
							if(sval=='all'){sval=null}
							dashboard.setLocation(urlForMapState({
								district: district,
								filter: 'surveyor',
								obj: sval
							}))
						})
					});
					
					if(filterItem && filterItem!=='undefined') {
						Showing = Showing.filter('surveyor', filterItem)
					}
					_MapEnv.display(Showing, {
						hideList: list,
						boundWindow: true
					});
				})
			})
		});
		//end #/map/district/by/surveyor/*
		
		dashboard.get("#/map/:district/by/survey/?(:obj)?", function(){
			var district = findDistrict(this.params['district']),
				obj = this.params['obj'],
				survey = obj;
			
			var title;
			if(survey && survey !== 'undefined') {
				title = "Map "+district.name+" by Survey"
			} else {
				title = "Map "+district.name+" by Survey: "+survey.toUpperCase();
			}
			this.switchTo("map", {title:title});
			mapState = changeMapState(mapState, {
				scale: 'district',
				district: district.name,
				filter: "survey",
				xyz: survey
			})
			this.Map(function(){
				this.mapCenter(district.GLatLng(), {'zoom': 8})
				this.key({clear:true});
				
				
				this.addSelector({text:"District"}, function(selector){
					var main = $("<option />", {value:'all'}).html("Nigeria");
					var big = $("<optgroup />", {'label':"Selector"}).html(main);
					
					var subdistricts = $("<optgroup />", {'label':"LGA"});
					$(districts).each(function(){
                        var opt = $("<option />", {value: this.id}).html(this.name)
	                    subdistricts.append(opt);
	                })
	                selector.append(big);
					selector.append(subdistricts);
					
					selector.val(district.id);
					selector.change(function(){
						if($(this).val()=='all') {
							dashboard.setLocation("#/map");
						} else {
							dashboard.setLocation(urlForMapState({district: $(this).val()}));
						}
					});
				});

				var Showing, _MapEnv = this;
				WithActivityList(function(_list){
					_MapEnv.addSelector({list:getFilters(_list).filters,text:"Filter"}, function(selector){
						var all = $("<option />", {value: 'all'});
						selector.prepend(all);

						if(!mapState.filter){selector.val('all')}else{selector.val(mapState.filter)}

						selector.change(function(){
							var cval = $(this).val();
							if(cval=='all'){cval=null;}

							dashboard.setLocation(urlForMapState({
								district: district,
								filter: cval
							}));
						})
					});
					
					
					Showing = _list.filter('district_id', district.id);

					_MapEnv.addSelector({list:Showing.getVarieties()['survey'],text:"Survey"}, function(selector){
						selector.prepend($("<option />", {'value':'all'}))
						selector.val(survey);
						selector.change(function(){
							var oVal = $(this).val();
							if(oVal=='all') {oVal=null;}
							dashboard.setLocation(urlForMapState({
								district: district,
								filter: 'survey',
								obj: oVal
							}));
						});
					});

					if(survey && survey!=="undefined") {
						Showing = Showing.filter('survey', survey);
					}
					_MapEnv.display(Showing, {
						hideList: _list,
						boundWindow: true
					})
				})
			})
		});
		//end #/map/district/by/survey/*

		dashboard.get("#/map/:district/by/date/?(:obj)?", function(){
			var district = findDistrict(this.params['district']),
				obj = this.params['obj'],
				filterItem = this.params['obj'],
				date = filterItem;

			var title;
			if(date && date!=='undefined') {
				title = "Map "+district.name+" by Date";
			} else {
				title = "Map "+district.name+" by Date: "+date;
			}
			this.switchTo("map", {title:title});
			
			mapState = changeMapState(mapState, {
				scale: 'district',
				district: district.name,
				filter: "date",
				xyz: date
			})
			this.Map(function(){
				this.mapCenter(district.GLatLng(), {'zoom': 8})
				this.key({clear:true});
				
				this.addSelector({list:[],text:"District"}, function(selector){
					var main = $("<option />", {value:'all'}).html("Republic of Nigeria");
					var big = $("<optgroup />", {'label':"State View"}).html(main);
					
					var subdistricts = $("<optgroup />", {'label':"LGA View"});
					$(districts).each(function(){
                        var opt = $("<option />", {value: this.id}).html(capitalizeString(this.name))
	                    subdistricts.append(opt);
	                })
	                selector.append(big);
					selector.append(subdistricts);
					
					selector.val(district.id);
					selector.change(function(){
						if($(this).val()=='all') {
							dashboard.setLocation("#/map");
						} else {
							dashboard.setLocation(urlForMapState({district: $(this).val()}));
						}
					});
				});

				var Showing, _MapEnv = this;
				WithActivityList(function(_list){
					_MapEnv.addSelector({list:getFilters(_list).filters,text:"Filter"}, function(selector){

						selector.prepend($("<option />", {value: 'all'}));

						if(!mapState.filter){selector.val('all')}else{selector.val(mapState.filter)}

						selector.change(function(){
							var cval = $(this).val();
							if(cval=='all'){cval=null;}
							dashboard.setLocation(urlForMapState({
								district: district,
								filter: cval
							}));
						})
					})

					Showing = _list.filter('district_id', district.id)
					_MapEnv.addSelector({list:Showing.getVarieties().date,text:"Date"}, function(selector){

						selector.prepend($("<option />", {value: 'all'}));
						selector.val(date);
						selector.change(function(){
							var thisVal = $(this).val();
							if(thisVal=="all") {
								thisVal=false;
							}
							dashboard.setLocation(urlForMapState({
								district: district,
								filter: 'date',
								obj: thisVal
							}));
						})
					});

					if(date && date!=='undefined') {
						Showing = Showing.filter('date', filterItem);
					}
					_MapEnv.display(Showing, {
						hideList: _list,
						boundWindow: true
					})
				})
			})
		});
		//end #/map/district/by/date/*
	});
	
	var __map;
</script>
<script id="survey-view" type="text/x-jquery-tmpl">
   	<div class="survey-view" title="${title}">
	<table class="fullw">
		<tr>
			<td style="width:48%">
				<div class='im-wrap'>
					<img src="${image_url}" width="100%" />
					<p class='im-caption'>
						${photoContextString}
					</p>
				</div>
			</td>
			<td style="width:48%;vertical-align:top">
				<div class="survey-content" style="overflow:auto;max-height:340px"></div>
			</td>
		</tr>
	</table>
	</div>
</script>
<script type="text/javascript" charset="utf-8">
	var surveyViewTemplate = $('#survey-view').template();
</script>

<script type="text/javascript" charset="utf-8">

	/*  WithActivityList is a structure that executes a callback in the context of a
	-   the global "ActivityCaller" object, which has methods for handling the activity
	-   data.
	*/
	var cachedAt = false;
	(function($){
	    var dataUrl = baseUrl + "data/map_data/",
	        callbacks = [],
	        listCaller = {},
	        activityList = [];

	    function WithActivityList(cb, opts){
	        if (Modernizr.localstorage) {
	            if(!cachedAt) {
	                callbacks.push(cb);
	                $.retrieveJSON(dataUrl, function(data, status, cacheStatus){
	                    cachedAt = cacheStatus;
	                    if(cacheStatus && cacheStatus.retrievedAt) {
	                        //bury
	                    } else {
	                        // storage.set('activity_stamp', [data.stamp]);
	                        listCaller.list = new ActivityList(data);
	                        window.__list = listCaller.list;
	                        $(callbacks).each(function(){
	                            this.call(listCaller, listCaller.list);
	                        });
	                        callbacks = [];
	                    }
	                });
	            } else {
	                cb.call(listCaller, listCaller.list);
	            }
	        } else {
	            callbacks.push(cb);
	            $.getJSON(dataUrl, function(data, status){
	                listCaller.list = new ActivityList(data);
	                window.__list = listCaller.list;
	                $(callbacks).each(function(){
	                    this.call(listCaller, listCaller.list);
	                });
	                callbacks = [];
	            });
	        }
	    }
	    window.WithActivityList = WithActivityList;
	})(jQuery);
	
/*-- Frequency Tables
--*/

$(function(){
	function parseFreqTable(data) {
		var columns = data.column_headers,
			rows = data.row_headers;

		var table = $("<table />");
		var thead = $("<thead />"),
			tbody = $("<tbody />");
		var curRow = $("<tr />").html("<th />");
		$.each(columns, function(k, v){
			curRow.append($("<th />").html(v.text));
		});
		thead.append(curRow);
		table.append(thead);


		$.each(rows, function(k, v){
			curRow = $("<tr />");
			var rowId = v.id,
				rowData = data.cells[rowId],
					rowHeader = $("<td />").html(v.text);
			curRow.append(rowHeader);
			$.each(columns, function(k, v){
				var colId = v.id, text = "";
				if($.type(rowData)!=='undefined' && rowData && rowData[colId]) {
					text = rowData[colId];
				}
				curRow.append($("<td />", {'class':'data'}).html(text));
			})

			tbody.append(curRow);
		})
		table.append(tbody);
		return table;
	}
	
	dashboard.get("#/frequency-tables", function(context){
		this.switchTo("frequency-tables");
        this.title("Frequency Tables");
    });
	dashboard.get("#/frequency-tables/:row/:col", function(context){
		this.switchTo("frequency-tables");
        this.title("Frequency Tables");

		var row = this.params['row'],
			col = this.params['col'],
			freqTable = $("#freq-table");

		$('#freq-rows').val(row);
		$('#freq-cols').val(col);
		$.retrieveJSON(baseUrl+"submission-counts/"+row+"/"+col, function(tableData){
			var table = parseFreqTable(tableData);

			table.addClass('ptable');
			$('tr td', table).each(function(ct, elm){
				var td = $(elm);
				if(td.index()==0) {
					td.addClass('rname');
				} else {
					td.addClass('centered data');
					if(td.text()!=="") {
						td.wrapInner("<div class='dwrap' />")
					}
				}
			});
			$('tr td:first-child', table).removeClass('centered').addClass('rname');
			// 
			(function sumRows(tab){
				var rows = $("tbody tr", tab);
				$('thead tr th:first-child', tab).after($("<th />", {'class':'sum-header'}).html('Total'));
				rows.each(function(){
					var sumTd = $("<td />", {'class':'row sum centered'});
					var sum = 0;

					$("td.data", this).each(function(){
						if($(this).text()) {
							sum += parseInt($(this).text())
						}
					});
					sumTd.html(sum);
					$(this).find('td:first-child').after(sumTd);
				})
			})(table);
			// 
			(function sumCols(tab){
				var columnsWithData=[];
				var rows = $("tbody tr", tab);
				rows.find('td.data').each(function(){
					if(!columnsWithData[$(this).index()]) {
						columnsWithData[$(this).index()]=true;
					}
				});
				var totaltotal=0;
				var totalSpan = $("<span />")
				var sumRow = $("<tr />", {'class':'sum-row'});
				$.each(columnsWithData, function(ct, tf){
					var td = $("<td />");
					if(ct===0) {
						td.addClass("rname").text("Total:");
					} else if(ct===1) {
						td.addClass("centered").css({'color':'#fff', 'background-color':'#333'}).html(totalSpan)
					}
					if(tf) {
						var sumVals = 0;
						rows.each(function(){
							var txtVal = $($(this).children()[ct]).text(),
								nmVal = parseInt(txtVal);
							if(!isNaN(nmVal)) {
								sumVals += parseInt(nmVal);
							}
						});
						totaltotal+=sumVals;
						td.text(sumVals);
						td.addClass('centered');
						td.addClass('totals');
					}
					sumRow.append(td);
					totalSpan.html(totaltotal);
				});
				$("thead", tab).append(sumRow);
			})(table);
//			$('.data', table).css({'width':50})
			freqTable.html($("<div />", {'class':'ft-wrap'}).html(table));
		});
	});
	
});
	
</script>

{% endblock %}