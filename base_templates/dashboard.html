{% extends "base.html" %}
{% block htitle %}Dashboard{% endblock %}
{% block title %}Dashboard{% endblock %}

{% block scripts %}
<script type="text/javascript" charset="utf-8">
//	var baseUrl = "{{dashboard_base_url}}";
</script>
<link rel="stylesheet" href="/site-media/css/map-key.css" type="text/css" media="all" title="Sitewide" charset="utf-8" />
{% endblock %}

{% block content %}
<div class="full-content sliding" id="main">
	<div class="iwrap" id="dashboard">
		<div class="iiwrap">
			<!-- Copied from "export_list.html" -->
			<table class="pretty padded">
				<thead>
					<tr>
				    <th>Title</th>
				    <th>Number of Submissions</th>
				    <th>Time of Last Submission</th>
				    <th>Export</th>
				  </tr>
				</thead>
				<tbody>
			{% for xform in xforms %}
				<tr>
				  <td>{{ xform.title }}</td>
				  <td>{{ xform.submission_count }}</td>
				  <td>
				    {% if xform.time_of_last_submission %}
				    {{ xform.time_of_last_submission }}
				    {% endif %}
				  </td>
				  <td>
				    {% if xform.submission_count %}
				    <a href={% url parsed_xforms.views.csv_export id_string=xform.id_string %}>csv</a>
				    {% endif %}
				  </td>
				</tr>
			{% endfor %}
			</tbody>
			</table>
		</div>
	</div>
	<style type="text/css">
	#pretty-table-wrap {
		z-index:999;
	}
	table#state-lga-list tbody tr.lga-row {
		display: none;
	}
	table#state-lga-list tbody.opened tr.lga-row {
		display: table-row;
	}
	table#state-lga-list tbody.opened tr.lga-row td {
		background-color: #f6f6f6;
		border-bottom-color: #ddd;
		color: #333;
	}
	table#state-lga-list tbody.opened tr.lga-row td, table#state-lga-list tbody.opened tr.lga-row td a { color: #333; }
	table#state-lga-list tbody.opened tr.state-row td {
		border-bottom: 1px solid #bbb;
	}
	table#state-lga-list span.lga-count {
		font-size: 10px;
		color: #888;
	}
	table#state-lga-list tr.state-row {
		cursor: pointer;
	}
	table#state-lga-list a.discrete-link {
		color: #777;
		font-size: 11px;
	}
	table#state-lga-list td.h-bar {
		width: 5px;
		padding: 0;
		background-color: #eee;
	}
	table#state-lga-list tbody.opened td.h-bar {
		background-color: #999;
	}
	table#state-lga-list tbody.opened tr.lga-row td.h-bar {
		background-color: #bbb;
		border-color: #999;
	}
	table#state-lga-list tfoot td.h-bar {
		background-color: transparent;
		border-color: transparent;
	}
	table#state-lga-list tfoot td {
		border-bottom-color: transparent;
	}
	table#state-lga-list tfoot td.total-total {
		color: #222;
		background-color: #ccc;
		font-weight: bold;
		border-color: #777;
		border-width: 1px 0 0 1px;
	}
	table#state-lga-list a {
		display: block;
	}
	table#state-lga-list .tot-span {
		font-size: smaller;
		font-weight: normal;
		color: #777;
	}
/*--	table#state-lga-list td.lga-name span.lga-name-prefix {color: #eee;} --*/
	a.img-link {
		float: left;
		display: block;
		width: 80px;
		max-height: 80px;
		margin: 2px 8px 8px 0;
	}
	a.img-link img {
		max-width: 80px;
		max-height: 80px;
	}
	table.popup-context td {
		font-size: 11px;
		color: #777;
	}
	table tr.total-row td.total {
		font-weight: bold;
		border-top: 1px solid #aaa;
		color: #222;
	}
	table td.total {
		font-weight: bold;
		border-left: 1px solid #aaa;
		color: #222;
		text-align: center;
	}
	table tr.lga-row td {
		font-weight: normal;
		font-size: 11px;
	}
	table tr.lga-row td.total {
		font-weight: bold;
	}
	table thead th.survey-col-header {
		width: 120px;
		text-align: center;
	}
	</style>
	<div class="iwrap" id="lga-list">
		<div class="iiwrap">
			<div class='pretty-table-wrap'>
			<p class="info">
				Phase II states are listed in the table below. Click on a state to see LGAs surveyed, and click the LGA name to see a map of the submitted surveys.
			</p>
			<table border="0" class="pretty padded" id="state-lga-list">
				<thead>
					<tr>
						<th colspan="4"></th>
						{% for title in zone_table.survey_titles %}
						<th class="survey-col-header">{{title}}</th>
						{% endfor %}
						<th><span class='tot-span'>TOTAL</span></th>
					</tr>
				</thead>
				{% for state in zone_table.states %}
				<tbody>
					<tr class="state-row">
						<td class="h-bar"></td>
						<td>{{state.zone_name}}</td>
						<td>{{state.name}}</td>
						<td>
							<span class="lga-count">({{state.lga_count}} LGAs Surveyed)</span>
						</td>
						{% for tot in state.survey_totals_by_title %}
						<td class="centered">{{tot}}</td>
						{% endfor %}
						<td class="state total">
							<span class="total">{{state.total_count}}</span>
						</td>
					</tr>
					{% for lga in state.lga_list %}
					<tr class="lga-row">
						<td class="h-bar"></td>
						<td><a href="#/map/lga/{{lga.pk}}" class="discrete-link">[View Map]</a></td>
						<td colspan="2" class="lga-name">
							<a href="#/map/lga/{{lga.pk}}">
								{{lga.name}}</a></td>
						{% for tot in lga.survey_totals_by_title %}
						<td class="centered">{{tot}}</td>
						{% endfor %}
						<td class="lga total">
							<span class="total">{{lga.total_count}}</span>
						</td>
					</tr>
					{% endfor %}
				</tbody>
				{% endfor %}
				<tfoot>
					<tr class="total-row">
						<td class="h-bar"></td>
						<td colspan="3" style="text-align:right"><span class="tot-span">TOTAL</span></td>
						{% for tot in zone_table.survey_totals_by_title %}
						<td class="centered total">{{tot}}</td>
						{% endfor %}
						<td class="total-total">{{zone_table.total_total}}</td>
					</tr>
				</tfoot>
			</table>
			</div>
			<div id="map-wrap" style="position:absolute;width:100%;height:100%;top:0;left:0;z-index:0;">
				<div id="map-div" style="height:96%;margin:9px">
				</div>
			</div>
		</div>
	</div>
	<div class="iwrap" id="activity">
		<div class="iiwrap">
			<h2>
				Activities
			</h2>
			<table id="activity-list" class="shade-alternate fullw padded">
				<thead>
					<tr>
						<th>Date</th>
						<th>Surveyor</th>
						<th>Title</th>
						<th>Survey Type
						</th>
					</tr>
				</thead>
			</table>
		</div>
	</div>
	<div class="iwrap" id="frequency-tables">
		<div class="iiwrap">
			<div id="freq-table-selector" style="position:relative">
				<div class="map-key-ww"><div class="map-key-w" style="padding:8px">
					<div id="m-key" class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix">
						<table>
							<tbody>
								<tr>
									<td class="selectors">
										<div class="selector-wrap">Rows
											<select id="freq-rows"></select>
										</div>
										<div class="selector-wrap">Columns
											<select id="freq-cols"></select>
										</div>
										<a href="#" style="margin-left:20px" id="get-table">Get Table</a>
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div></div>
			</div>
			<div id="freq-table" style="padding:65px 15px 10px 15px;"></div>
		</div>
	</div>
	<div class="iwrap" id="map">
		<div class="iiwrap">
			<div class="map-wrap">
			</div>
		</div>
	</div>
</div>

{% endblock %}
{% block js %}
<script type="text/javascript" src="/site-media/js/sammy.extensions.js"></script>

<script type="text/javascript" charset="utf-8">

(function(listTable){
	listTable.find('tr.state-row').click(function(){
		if($(this).hasClass('selected')) {
			$(this).removeClass('selected')
				.parents('tbody').removeClass('opened');
			$(listTable).removeClass('active');
		} else {
			$('tbody.opened', listTable).removeClass('opened');
			$('.selected', listTable).removeClass('selected');
//			$(this).parents('table').addClass('active').find('.selected').removeClass('selected');
			$(this).addClass('selected')
				.parents('tbody').addClass('opened');
			$(listTable).addClass('active');
		}
	})
})($('#state-lga-list'))

/*-- clickr is a temporary shortcut to clear localstorage
var clickr = $("<a />", {href:'#','class':'dontChangePage'});
clickr.html('.');
clickr.css({'text-decoration':'none'});
clickr.click(function(){storage.clear('activity');});
$('.account_links').append(clickr);
$('.dontChangePage').live('click', function(evt){evt.preventDefault();})
--*/

	$('.button').button();
	
	function capitalizeString(str) {
	    return str.slice(0,1).toUpperCase() + str.slice(1);
	}
	
	var SetResizer = (function($, resizeSelector, excludeSelector, extraPadding){
		var resizeElem = $(resizeSelector),
			excludeElem = $(excludeSelector);

		function ResizePage(){
			var windowHeight = $(window).height(),
				totalHeight = windowHeight - extraPadding;

			excludeElem.each(function(){totalHeight -= $(this).height();});
			resizeElem.css({'height':totalHeight})
		}
		$(window).resize(ResizePage);

		$(function(){
			resizeElem.css({'overflow':'auto'});
			$(document.body).css({'overflow':'hidden'})
			$(window).trigger('resize')
		});
	});
	(function($){
		$.fn.thinButton = function(){
			this.button();
			$('span.ui-button-text', this).css({'padding':'1px 5px'});
			return this;
		}
	})(jQuery);


	SetResizer(jQuery, ".iiwrap", "#header, #menu", (16+24));

</script>
<script type="text/javascript" charset="utf-8">
(function(){
    Sammy.GoogleMaps = function(){
        var loadStarted = false,
            loadFinished = false,
            gmap = false,
            map,
            mapKey = false,
            gmapElem = false;
        this.setMapElem = function(elem){
            gmapElem = $(elem);
        }
        function mapObj() {
            this.sammyMap=true;
        }
        $.extend(mapObj.prototype, {
            mapCenter: function(center, opts){
                var zoom = opts.zoom;
                if(opts.bounds) {
                    var ne = new google.maps.LatLng(opts.bounds.lat.min, opts.bounds.lng.min);
                    var sw = new google.maps.LatLng(opts.bounds.lat.max, opts.bounds.lng.max);
                    var bounds = new google.maps.LatLngBounds(sw, ne);
                }
                this.map.setCenter(center);
                if(zoom) {
                    this.map.setZoom(zoom)
                }
            },
            ensureDistrictKmls: function(){
                var _map = this.map;
                $(districts).each(function(){
                    this.ensureKmlLoaded(_map);
                })
            },
            display: function(list, opts){
                if(!opts){var opts={}}
                if(opts.hideList) {
                    $(opts.hideList).each(function(){
                        if(list.indexOf(this)==-1) {
                            this.hideMapPoint();
                        } else {
                            this.showMapPoint();
                        }
                    })
                } else {
                    $(arr).each(function(){
                        this.showMapPoint();
                    });
                }
                if(opts.boundWindow) {
                    var curWindow = list.latLngWindow();
					if(curWindow) {
						this.setMapCenter(curWindow.lat, curWindow.lng, curWindow)
					}
                }
            },
            key: function(opts){
                if(!this.mapKey) {
                    this.mapKey = MapKey.create()
                    gmapElem.parent().append(this.mapKey)
                }
                if(opts && opts.clear) {
                    MapKey.selectors().empty();
                }
				return this.mapKey;
            },
            addSelector: function(opts, fn){
                var choices = opts.list || [],
                    text = opts.text,
                    selector = $("<select />");

                $(choices).each(function(){
                    if(this.name) {
                        var opt = $("<option />", {value: this.id}).html(capitalizeString(this.name))
                    } else {
                        var opt = $("<option />", {value: String(this)}).html(capitalizeString(String(this)));
                    }
                    selector.append(opt);
                });

                var selectorDiv = $("<div />", {'class':'selector-wrap'}).html(text);
                selectorDiv.append(selector);
                MapKey.selectors().append(selectorDiv);
                fn.call(this, selector);
            },
            divider: function(){
                MapKey.addDivider();
            },
            debug: function(mapState){
                str = "";
                str += "scale: " + mapState.scale
                if(mapState.district) {
                    str += " &mdash ";
                    str += "district: " + mapState.district
                }
                if(mapState.filter) {
                    str += " &mdash ";
                    str += "filter: " + mapState.filter
                }
                if(mapState.xyz) {
                    str += " &mdash ";
                    str += "x: "+ mapState.xyz
                }
                if(mapState.points) {
                    str += " &mdash ";
                    str += "point count: "+ mapState.points.length
                }
            },
            setMapCenter: function(lat, lng, opts){
                var opts = opts || {};
                var zoom = opts.zoom;
                this.map.setCenter(new google.maps.LatLng(lat, lng))
                if(opts.range) {
                    var ne = new google.maps.LatLng(opts.range.lat.min, opts.range.lng.max);
                    var sw = new google.maps.LatLng(opts.range.lat.max, opts.range.lng.min);
                    var bounds = new google.maps.LatLngBounds(sw, ne);
                    this.map.fitBounds(bounds);
                }
            },
            defaultCenter: function(){
                this.map.setZoom(defaultMapCenter.zoom);
                this.map.setCenter(new google.maps.LatLng(defaultMapCenter.lat, defaultMapCenter.lng))
            },
            getMapElem: function(){return gmapElem}
        });
        map = new mapObj();

        this.helper('SetMapElem', function(elem){gmapElem = $(elem)});
        var mapLoadCallbacks = [];
        this.helper('addMapLoadCallback', function(cb){mapLoadCallbacks.push(cb);})
		function addNga113Map(map){
			var l = google.maps.KmlLayer("/site-media/kml/113_lgas.kml");
			l.setMap(map);
		}
        this.helper('Map', function(cb){
            mapLoadCallbacks.push(cb);
            if(!loadFinished) {
                var sammyObj = this;
                gmapElem.bind('gmapLoaded', function(){
                    //make the map and call the callback with the first argument as the map object
                    gmap = new google.maps.Map(gmapElem.get(0), {zoom:6,center:new google.maps.LatLng(9.243092645104804, 7.9156494140625), mapTypeId:'terrain', mapTypeControl: false});
					addNga113Map(gmap);
                    _map = gmap;
                    map.map = gmap;
//                    cb.call(map);
                    $(mapLoadCallbacks).each(function(){
                        this.call(map);
                    })
                });
            } else {
                if(!gmap) {
                    gmap = new google.maps.Map(gmapElem.get(0), {zoom:6,center:new google.maps.LatLng(9.243092645104804, 7.9156494140625), mapTypeId:'terrain', mapTypeControl: false });
					addNga113Map(gmap);
                    map.map = gmap;
                    _map = gmap;
                }
                // cb.call(map);
                $(mapLoadCallbacks).each(function(){
                    this.call(map);
                })
            }
            if(!loadStarted) {
                $.getScript('http://maps.google.com/maps/api/js?sensor=false&callback=SammyMapLoaded');
                loadStarted = true;
            }
        });
        SammyMapLoaded = function(){
            loadFinished = true;
            if(gmapElem) {
                $(gmapElem).trigger('gmapLoaded');
            }
        }
    }
})();

var MapKey = (function(){
	var mapKeyElem,
	    mapKeySelectors,
	    mapTypeSelectors,
		mapPar;
	return {
		create: function(){
		    var odiv = $.json2dom([
		            "div", {'class':'map-key-ww'}, [
		                "div", {'class': 'map-key-w'}, [
		                    "div", {'class': 'ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix', 'id': 'm-key'},
		                        ["table", {}, ["tbody", {}]]
		                ]
		            ]
		        ]);

		    this.tr = $("<tr />");
		    this.tr.append($("<td />", {'class':'empty-spacer'}).html("<div />"));

		    mapKeySelectors=$('<td />', {'class':'selectors'});
	        this.tr.append(mapKeySelectors);

	        this.appendMapTypeSelector();

		    $("tbody", odiv).append(this.tr);
			return odiv;
		},
		prependButton: function(text, url){
			this.tr.prepend($("<td />").html($("<a />", {'href':url}).html(text).thinButton()));
		},
		appendMapTypeSelector: function(){
		    mapTypeSelectors = $("<td />", {'id':'map-type-choices'})
		    var terrainButton = $("<a href='#'>Terrain</a>");
            terrainButton.click(function(evt){
                _map.setMapTypeId(google.maps.MapTypeId.TERRAIN);
                evt.preventDefault();
            });
            var satelliteButton = $("<a href='#'>Satellite</a>");
            satelliteButton.click(function(evt){
                _map.setMapTypeId("satellite")
                evt.preventDefault();
            });
            var mapButton = $("<a href='#'>Map</a>");
            mapButton.click(function(evt){
                _map.setMapTypeId('roadmap')
                evt.preventDefault();
            });
            var tDiv = $("<div />").css({'float':'right'});
            tDiv.append(terrainButton).append(satelliteButton).append(mapButton);
            mapTypeSelectors.append(tDiv);
            $('a', mapTypeSelectors).button().find('span.ui-button-text').css({'padding':'1px 5px'});
            this.tr.append(mapTypeSelectors);
		},
		selectors: function(){
		    return mapKeySelectors;
		},
		empty: function(){
		    this.tr.empty();
		},
		insert: function(cb){
		    var td = $("<td />").html(cb);
		    this.tr.append(td);
		},
		addDivider: function(){
			this.tr.append($("<td />").html($("<div />", {'class':'table-spacer'})));
		},
		addDistrictDropdown: function(){
			this.districtSelector = $("<select />");
			var nigeria = $("<option />", {value:'all'}).html("Republic of Nigeria");
			var allOpt = $("<optgroup />", {label:'Full view'}).html(nigeria)

			var districtView = $("<optgroup />", {label: 'District view'})
			this.districtSelector.append(allOpt);
			$(districts).each(function(){
				var opt = $("<option />", {value: this.id}).html(this.name);
				districtView.append(opt);
			});
			this.districtSelector.append(districtView);
			this.tr.append($("<td />").html(this.districtSelector));
			return this.districtSelector;
		},
		addChoiceDropdown: function(){
			this.addDivider();
			this.choiceSelector = $("<select />");
			this.choiceSelector.append($("<option>Date</option>"));
			this.choiceSelector.append($("<option>Surveyor</option>"));
			this.choiceSelector.append($("<option>Survey</option>"));
			this.iDiv.find('tr').append($('<td />').html(this.choiceSelector))
			return this.choiceSelector;
		},
		addSpecificityDropdown: function(choices){
			this.addDivider();
			var opt, selector = $("<select />");
			$(choices).each(function(){
				opt = $("<option />").html(this);
				selector.append(opt);
			});
			this.tr.append($("<td />").html(selector))
		},
		showSelection: function(pType) {
//				console.log("make selection for ", pType);
		}
	}
})();

	var dashboard = (function($){
	    var dashboard = $.sammy("#main", function(){
	        this.use(Sammy.Storage);
			
	        this.use(Sammy.SwitchTo);
	        this.use(Sammy.GoogleMaps);
			this.setMapElem("#map-div");
	

	        this.use(Sammy.Title);
	        this.setTitle(function(title){
	            return ["Baseline Data Collection: ", title].join("");
	        });

	        this.use(Sammy.Template);
	    });
	    $(function(){
	        dashboard.run("#/");
	        dashboard.switchToDuration(200);
	    });
	    return dashboard;
	})(jQuery);
	dashboard.activateSwitchTo(".full-content.sliding");
</script>

<script type="text/javascript" charset="utf-8">
	/*-- landing page
	--*/
	dashboard.get("#/", function(context){
        var dashbElem = this.switchTo("dashboard", {title: "Data"});
    });

	/*-- LGA/State List
	--*/
	
	//redirects to submission-counts
	dashboard.get("#/lga-list", function(){dashboard.setLocation("#/submission-counts");});
	
	dashboard.get("#/submission-counts", function(){
		var pageElem = this.switchTo("lga-list", {title: "LGA List"});
		$('.pretty-table-wrap', pageElem).fadeIn().css({'z-index':99});
		$("#map-wrap", pageElem).fadeOut();
	});
	
	dashboard.get("#/map/lga/:lga_id", function(){
		var lgaId = this.params.lga_id;
		var pageElem = this.switchTo("lga-list", {title: "LGA Map"});
		$('.pretty-table-wrap', pageElem).fadeOut();
		$("#map-wrap", pageElem).fadeIn();
		var that = this;
		
		var oneTime = 0;
		
		$.retrieveJSON("/xforms/map_data_points/"+lgaId+"/", function(data){
			if(!oneTime++) {
				var list = new ActivityList(data);
				var llWindow = list.latLngWindow();
				if(llWindow) {
					var neBounds = [llWindow.range.lat.max, llWindow.range.lng.max];
					var swBounds = [llWindow.range.lat.min, llWindow.range.lng.min];
					that.Map(function(){
						__map = this.map;
						var center = new google.maps.LatLng(llWindow.range.lat.avg,
											llWindow.range.lng.avg);
						var ne = new google.maps.LatLng(neBounds[0], neBounds[1]);
						var sw = new google.maps.LatLng(swBounds[0], swBounds[1]);
	                    var bounds = new google.maps.LatLngBounds(sw, ne);
						this.map.fitBounds(bounds);
						var map = this.map;
						var nav = this.key({clear:true});
						MapKey.empty();
						MapKey.appendMapTypeSelector();
						MapKey.prependButton("&laquo; Back to the List of LGAs", "#/submission-counts");
						list.each(function(){
							if(!this.gps) {
								return;
							}
							if(!this.pt) {
								var position = new google.maps.LatLng(this.gps.lat, this.gps.lng);
								this.pt = new google.maps.Marker({
									title: this.title,
									position: position,
									icon: this.icon()
								});
								this.pt.activityPoint = this;
								this.pt.setMap(map);
								var thatPt = this;
								google.maps.event.addListener(this.pt, 'click', function(){
									var oneTime = 0;
									var jsonUrl = "/xforms/survey/"+this.activityPoint.instanceId+"/";
									$.retrieveJSON(jsonUrl, function(data){
										if(!oneTime++) {
											InstancePopup(thatPt, data);
										}
									})
				        		});
							}
						})
					})
				}
			}
		});
	});
	
	var MapPopup = (function(){
		var showing = false;  //,		  wrapElem;
		return (function show(elem){
			if(showing) {
				$(showing).dialog('close');
				$(showing).remove();
			}
			$(elem).dialog({
				resizable: false,
				width: 600
			});
			showing = elem;
		});
	})();
	
	function InstancePopup(activityPoint, data) {
		var popupElem = $("<div />", {'style':'max-height:500px;overflow:auto'});
		if(activityPoint.imageUrl) {
			popupElem.append($("<div />", {'class': 'instance-image'}).html());
		}
		var topContext = $("<tbody />");
//		topContext.append($("<tr />", {'rowspan':4}).html())
		var link = $("<a />", {'href': activityPoint.imageUrl, target: '_blank', 'class': 'img-link'}).html($("<img />", {'src': activityPoint.imageUrl}));
		var tcWrap = $("<div />", {'class':'clearfix'}).append(link).append($("<table />", {'class':'popup-context'}).html(topContext));
		var ddList = $("<dl />", {'style':'clear:both'});
		$.each(data, function(i, qaPair){
			if(qaPair[0]=="imei") {
				var tr = $("<tr />");
				tr.append($("<td />").text("Device ID"))
					.append($("<td />").text(qaPair[1]))
				topContext.append(tr)
			} else if(qaPair[0]=="start_time") {
				var tr = $("<tr />");
				tr.append($("<td />").text("Start Time"))
					.append($("<td />").text(qaPair[1]))
				topContext.append(tr)
			} else if(qaPair[0]=="end_time") {
				var tr = $("<tr />");
				tr.append($("<td />").text("End Time"))
					.append($("<td />").text(qaPair[1]))
				topContext.append(tr)
			} else {
				ddList.append($("<dt />").text(qaPair[0]))
					.append($("<dd />").text(qaPair[1]));
			}
		});
		popupElem.append(tcWrap);
		popupElem.append(ddList);
		MapPopup($("<div />", {title: activityPoint.title}).html(popupElem))
	}
	
	var ActivityList, ActivityPoint;
	(function($){
		function _ActivityList(arr){
			if(arr){
				this.addPoints(arr)
			}
		}
		_ActivityList.prototype = new Array();
		$.extend(_ActivityList.prototype, {
			find: function(id){
				var i = 0, l=this.length;
				for(;i<l;i++) {
					if(id==this[i].id) {
						return this[i];
					}
				}
				return false;
			},
			each: function(cb){
				$(this).each(cb);
			},
			filter: function(k, v){
				var subList = new _ActivityList([]);
				if($.type(v)=='string') {
					v=v.toLowerCase();
				}
				$(this).each(function(){
					if($.type(this[k])==='string') {
						if(this[k].toLowerCase()===v) {
							subList.addPoint(this);
						}
					} else {
						if(this[k]===v) {
							subList.addPoint(this)
						}
					}
				});
				return subList;
			},
			addPoint: function(point){
				this.push(new _ActivityPoint(point))
			},
			addPoints: function(points){
				var _Sl = this;
				$(points).each(function(){_Sl.addPoint(this)});
			},
			latLngWindow: function(){
				var lats = [], lngs = [];
				$.each(this, function(){
					if(this.gps && this.gps.lat) {
						lats.push(this.gps.lat);
						lngs.push(this.gps.lng);
					}
				});
				if(lats.length == 0 || lngs.length==0) {
					return null;
				}
				var llRange = {
					lat: {
						min: Math.min.apply(this, lats),
						max: Math.max.apply(this, lats)
					},
					lng: {
						min: Math.min.apply(this, lngs),
						max: Math.max.apply(this, lngs)
					}
				}
				llRange.lat.avg = (llRange.lat.min + llRange.lat.max)/2
				llRange.lng.avg = (llRange.lng.min + llRange.lng.max)/2
				return {
					lat: llRange.lat.avg,
					lng: llRange.lng.avg,
					range: llRange
				}
			},
			getVarieties: function(){
				var survey_types = [], dates = [], surveyors = [];
				$(this).each(function(){
					if(survey_types.indexOf(this.survey_type)==-1) { survey_types.push(this.survey_type); }
					if(dates.indexOf(this.date)==-1) { dates.push(this.date); }
					if(surveyors.indexOf(this.surveyor)==-1) { surveyors.push(this.surveyor); }
				});
				return {
					surveyor: surveyors,
					date: dates,
					survey: survey_types
				}
			}
		})

	    var months = "Jan Feb Mar Apr May June July Aug Sept Oct Nov Dec".split(" ");
		function _ActivityPoint(o){
			if(o instanceof _ActivityPoint) {return o}
			this._contents = o;
			var ll = o['location/gps'].split(" ");
			this.gps = {lat: ll[0], lng: ll[1]};
			this.surveyType = o._name;
			this.surveyor = o._surveyor_name;
			this.instanceId = o._id;
			this.time = o.start_time;
			this.title = this.surveyType;
			this.imageUrl = o._attachments[0];
			if(this.imageUrl) {this.imageUrl = '/site-media/'+this.imageUrl;}
		}
		var flagColors = "blue green orange pink purple red yellow".split(" ");
		var stColors = {
			water: "blue",
			health: "red",
			agriculture: "orange",
			lga: "purple",
			education: "green",
			defaultColor: "purple"
		};
		
		_ActivityPoint.prototype.icon = function(){
			var color;
			if(this.surveyType==undefined) {
				color = 'purple'
			} else {
				color = stColors[this.surveyType.toLowerCase()]
			}
			var icon = new google.maps.MarkerImage("/site-media/images/geosilk/flag_"+color+".png", new google.maps.Size(16, 16),
		        new google.maps.Point(0,0), new google.maps.Point(9, 15));
		    
			return icon;
		}
		_ActivityPoint.prototype.shadow = function(){
			var icon = new google.maps.MarkerImage("/site-media/images/gmap-smaller-dots/"+color+".png", new google.maps.Size(13, 13),
		        new google.maps.Point(0,0), new google.maps.Point(6, 6));
		    
			return icon;
		}
		
	    _ActivityPoint.prototype.mapPointListener = function(){
			var dest = $('<div />', {'class':'survey-content'});
			$.get(baseUrl+'survey/'+this.id+'/', function(data){
				dest.append(data);
			});
			MapPopup(dest);
	    }
		_ActivityPoint.prototype.district=function(){
			var result, district_id = this.district_id;
			if(this.district_id) {
				$(districts).each(function(){ if(this.id==district_id) {result = this} })
			}
			return result;
		}
		window.ActivityList = _ActivityList;
	})(jQuery);
</script>

{% endblock %}
